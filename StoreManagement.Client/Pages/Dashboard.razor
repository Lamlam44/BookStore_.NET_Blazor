@page "/dashboard"
@layout StoreManagement.Client.Layout.AdminLayout
@using StoreManagement.Client.Models
@using StoreManagement.Client.Services
@using System.Globalization
@inject IStoreService StoreService
@inject NavigationManager NavigationManager

<h3 class="mt-3">Dashboard Thống kê</h3>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="form-group">
            <label for="statisticType">Loại Thống kê:</label>
            <InputSelect @bind-Value="selectedStatisticType" class="form-control" id="statisticType" @onchange="UpdateDashboardData">
                <option value="@StatisticType.Revenue">Doanh thu</option>
                <option value="@StatisticType.BooksSold">Sách đã bán</option>
                <option value="@StatisticType.NewCustomers">Khách hàng mới</option>
            </InputSelect>
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-group">
            <label for="startDate">Ngày bắt đầu:</label>
            <InputDate @bind-Value="startDate" class="form-control" id="startDate" @onchange="@(_ => UpdateDashboardData())" />
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-group">
            <label for="endDate">Ngày kết thúc:</label>
            <InputDate @bind-Value="endDate" class="form-control" id="endDate" @onchange="@(_ => UpdateDashboardData())" />
        </div>
    </div>
</div>

@if (isLoading)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-white bg-primary mb-3">
                <div class="card-header">Doanh thu</div>
                <div class="card-body">
                    <h5 class="card-title">@totalRevenue.ToString("C0", new CultureInfo("vi-VN"))</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-header">Sách đã bán</div>
                <div class="card-body">
                    <h5 class="card-title">@totalBooksSold cuốn</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info mb-3">
                <div class="card-header">Khách hàng mới</div>
                <div class="card-body">
                    <h5 class="card-title">@newCustomersCount người</h5>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">Biểu đồ @GetStatisticTypeDisplayName()</div>
                <div class="card-body">
                    @* Simple Bar Chart Placeholder *@
                    <div style="display: flex; align-items: flex-end; height: 300px; border-left: 1px solid #ccc; border-bottom: 1px solid #ccc; padding-left: 5px; padding-bottom: 5px;">
                        @if (chartData.Any())
                        {
                            var maxChartValue = chartData.Max(cd => cd.Value);
                            var safeMax = maxChartValue > 0 ? maxChartValue : 1; // avoid division by 0
                            foreach (var item in chartData)
                            {
                                var barHeight = item.Value > 0 ? Math.Round(item.Value / safeMax * 250) : 2; // show minimal bar for zero
                                <div style="display: flex; flex-direction: column; align-items: center; margin: 0 5px;">
                                    <div style="background-color: @GetBarColor(); width: 30px; height: @($"{barHeight}px"); transition: height 0.5s;"></div>
                                    <small>@item.Label</small>
                                    <small>@item.Value.ToString("N0")</small>
                                </div>
                            }
                        }
                        else
                        {
                            <div>
                                <p>Không có dữ liệu để hiển thị.</p>
                                @if (!isLoading && (!allInvoices.Any() || allInvoices == null))
                                {
                                    <p class="text-muted">Gợi ý: Kiểm tra đăng nhập để tải dữ liệu hóa đơn (API yêu cầu xác thực).</p>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private DateTime startDate = DateTime.Now.Date;
    private DateTime endDate = DateTime.Now.Date.AddDays(30);
    private StatisticType selectedStatisticType = StatisticType.Revenue;

    private decimal totalRevenue;
    private int totalBooksSold;
    private int newCustomersCount;

    private List<Invoice> allInvoices = new List<Invoice>();
    private List<Customer> allCustomers = new List<Customer>();
    private List<ChartDataItem> chartData = new List<ChartDataItem>();

    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
        await UpdateDashboardData();
    }

    private async Task LoadInitialData()
    {
        isLoading = true;
        allInvoices = await StoreService.GetInvoicesAsync();
        Console.WriteLine($"[Dashboard] Loaded invoices: {allInvoices.Count}");
        // Assuming GetCustomersAsync without pagination is available and fetches all.
        // If not, we would need to implement pagination logic here.
        allCustomers = (await StoreService.GetCustomersAsync(1, 99999)).Data?.Items.ToList() ?? new List<Customer>(); // Using the paginated one for safety
        Console.WriteLine($"[Dashboard] Loaded customers: {allCustomers.Count}");
        isLoading = false;
    }

    private async Task UpdateDashboardData()
    {
        isLoading = true;
        // Ensure dates are correctly set for filtering (start of day, end of day)
        var filterStartDate = startDate.Date;
        var filterEndDate = endDate.Date.AddDays(1).AddTicks(-1); // End of the selected day
        Console.WriteLine($"[Dashboard] Update triggered. Start={filterStartDate:yyyy-MM-dd}, End={filterEndDate:yyyy-MM-dd HH:mm:ss}");

        // Diagnostic: list loaded invoices with status and times
        foreach (var inv in allInvoices)
        {
            Console.WriteLine($"[Dashboard] Invoice id={inv.Id}, FinalAmount={inv.TotalAmount}, Status={inv.Status}, PaymentTimeLocal={inv.PaymentTime:yyyy-MM-dd HH:mm:ss}");
        }

        // Filter Invoices
        var filteredInvoices = allInvoices
            .Where(inv => inv.Status == InvoiceStatus.Paid && inv.PaymentTime >= filterStartDate && inv.PaymentTime <= filterEndDate)
            .ToList();
        Console.WriteLine($"[Dashboard] Filtered paid invoices count: {filteredInvoices.Count}");

        // Filter Customers
        var filteredCustomers = allCustomers
            .Where(cust => cust.CreatedAt >= filterStartDate && cust.CreatedAt <= filterEndDate)
            .ToList();
        Console.WriteLine($"[Dashboard] Filtered customers count: {filteredCustomers.Count}");

        // Calculate Summary Cards
        totalRevenue = filteredInvoices.Sum(inv => inv.TotalAmount);
        totalBooksSold = filteredInvoices.SelectMany(inv => inv.InvoiceDetails).Sum(detail => detail.Quantity);
        newCustomersCount = filteredCustomers.Count;
        Console.WriteLine($"[Dashboard] Summary: revenue={totalRevenue}, booksSold={totalBooksSold}, newCustomers={newCustomersCount}");

        // Prepare Chart Data
        chartData = new List<ChartDataItem>();

        switch (selectedStatisticType)
        {
            case StatisticType.Revenue:
                chartData = filteredInvoices
                    .GroupBy(inv => inv.PaymentTime.Date)
                    .Select(g => new ChartDataItem
                    {
                        Label = g.Key.ToString("dd/MM"),
                        Value = (double)g.Sum(inv => inv.TotalAmount)
                    })
                    .OrderBy(cd => DateTime.ParseExact(cd.Label, "dd/MM", CultureInfo.InvariantCulture))
                    .ToList();
                Console.WriteLine($"[Dashboard] Chart data points (Revenue): {chartData.Count}");
                break;
            case StatisticType.BooksSold:
                chartData = filteredInvoices
                    .SelectMany(inv => inv.InvoiceDetails.Select(detail => new { inv.PaymentTime, detail.Quantity }))
                    .GroupBy(item => item.PaymentTime.Date)
                    .Select(g => new ChartDataItem
                    {
                        Label = g.Key.ToString("dd/MM"),
                        Value = (double)g.Sum(item => item.Quantity)
                    })
                    .OrderBy(cd => DateTime.ParseExact(cd.Label, "dd/MM", CultureInfo.InvariantCulture))
                    .ToList();
                Console.WriteLine($"[Dashboard] Chart data points (BooksSold): {chartData.Count}");
                break;
            case StatisticType.NewCustomers:
                chartData = filteredCustomers
                    .GroupBy(cust => cust.CreatedAt.Date)
                    .Select(g => new ChartDataItem
                    {
                        Label = g.Key.ToString("dd/MM"),
                        Value = (double)g.Count()
                    })
                    .OrderBy(cd => DateTime.ParseExact(cd.Label, "dd/MM", CultureInfo.InvariantCulture))
                    .ToList();
                Console.WriteLine($"[Dashboard] Chart data points (NewCustomers): {chartData.Count}");
                break;
        }

        isLoading = false;
        StateHasChanged(); // Notify Blazor to re-render the component
        Console.WriteLine("[Dashboard] Update complete and UI refreshed.");
    }

    private string GetStatisticTypeDisplayName()
    {
        return selectedStatisticType switch
        {
            StatisticType.Revenue => "Doanh thu",
            StatisticType.BooksSold => "Sách đã bán",
            StatisticType.NewCustomers => "Khách hàng mới",
            _ => string.Empty,
        };
    }

    private string GetBarColor()
    {
        return selectedStatisticType switch
        {
            StatisticType.Revenue => "blue",
            StatisticType.BooksSold => "green",
            StatisticType.NewCustomers => "teal",
            _ => "gray",
        };
    }

    // Enum for Statistic Types
    private enum StatisticType
    {
        Revenue,
        BooksSold,
        NewCustomers
    }

    // Helper class for Chart Data
    private class ChartDataItem
    {
        public string Label { get; set; } = string.Empty;
        public double Value { get; set; }
    }
}