@page "/receipts/create"
@using StoreManagement.Client.Models
@using StoreManagement.Client.Services
@inject IStoreService StoreService
@inject NavigationManager NavManager

<h3>üìù T·∫°o Phi·∫øu Nh·∫≠p Kho</h3>

<div class="row">
    <div class="col-md-4">
        <div class="card shadow-sm p-3 mb-3">
            <h5 class="card-title text-primary">Th√¥ng tin phi·∫øu</h5>
            
            <div class="mb-3">
                <label class="form-label">Nh√† cung c·∫•p:</label>
                <select class="form-select" @bind="newReceipt.SupplierId">
                    <option value="">-- Ch·ªçn nh√† cung c·∫•p --</option>
                    @if (suppliers != null)
                    {
                        foreach (var s in suppliers)
                        {
                            <option value="@s.Id">@s.SupplierName</option>
                        }
                    }
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">Ng√†y nh·∫≠p:</label>
                <input type="date" class="form-control" @bind="newReceipt.ReceiptDate" />
            </div>

            <div class="mb-3">
                <label class="form-label">Nh√¢n vi√™n nh·∫≠p:</label>
                <input type="text" class="form-control" value="NV001 - Admin" disabled />
            </div>

            <hr />
            <div class="d-flex justify-content-between align-items-center">
                <h5>T·ªïng ti·ªÅn:</h5>
                <h4 class="text-danger fw-bold">@CalculateTotalCost().ToString("N0") ƒë</h4>
            </div>

            <button class="btn btn-success w-100 mt-3" @onclick="SaveReceipt">
                <i class="bi bi-save"></i> L∆∞u Phi·∫øu Nh·∫≠p
            </button>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card shadow-sm p-3">
            <h5 class="card-title">Chi ti·∫øt h√†ng nh·∫≠p</h5>
            
            <div class="row g-2 align-items-end mb-3 bg-light p-2 rounded">
                <div class="col-md-4">
                    <label class="small">S√°ch:</label>
                    <select class="form-select form-select-sm" @bind="tempBookId">
                        <option value="">-- Ch·ªçn s√°ch --</option>
                        @if (books != null)
                        {
                            foreach (var b in books)
                            {
                                <option value="@b.Id">@b.Title</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="small">S·ªë l∆∞·ª£ng:</label>
                    <input type="number" class="form-control form-select-sm" @bind="tempQty" min="1" />
                </div>
                <div class="col-md-3">
                    <label class="small">Gi√° nh·∫≠p:</label>
                    <input type="number" class="form-control form-select-sm" @bind="tempUnitCost" />
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary btn-sm w-100" @onclick="AddDetail">Th√™m</button>
                </div>
            </div>

            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>S√°ch</th>
                        <th class="text-center">SL</th>
                        <th class="text-end">ƒê∆°n gi√°</th>
                        <th class="text-end">Th√†nh ti·ªÅn</th>
                        <th class="text-center">X√≥a</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var detail in receiptDetailsList)
                    {
                        <tr>
                            <td>@GetBookTitle(detail.BookId)</td>
                            <td class="text-center">@detail.QuantityReceived</td>
                            <td class="text-end">@detail.UnitCost.ToString("N0")</td>
                            <td class="text-end">@detail.TotalLineCost.ToString("N0")</td>
                            <td class="text-center">
                                <button class="btn btn-outline-danger btn-sm" @onclick="() => RemoveDetail(detail)">X</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    // Data lists
    private List<Supplier> suppliers;
    private List<Book> books;

    // Main Model
    private InventoryReceipt newReceipt = new InventoryReceipt { ReceiptDate = DateTime.Now };
    
    // Local list ƒë·ªÉ hi·ªÉn th·ªã tr√™n UI tr∆∞·ªõc khi l∆∞u
    private List<ReceiptDetail> receiptDetailsList = new List<ReceiptDetail>();

    // Temp inputs
    private string tempBookId;
    private int tempQty = 1;
    private decimal tempUnitCost = 0;

    protected override async Task OnInitializedAsync()
    {
        suppliers = await StoreService.GetSuppliersAsync();
        books = await StoreService.GetBooksAsync();
    }

    private void AddDetail()
    {
        if (string.IsNullOrEmpty(tempBookId) || tempQty <= 0) return;

        var detail = new ReceiptDetail
        {
            Id = Guid.NewGuid().ToString(), // BaseEntity ID
            BookId = tempBookId,
            QuantityReceived = tempQty,
            UnitCost = tempUnitCost,
            TotalLineCost = tempQty * tempUnitCost
        };

        receiptDetailsList.Add(detail);

        // Reset inputs
        tempQty = 1;
        // tempUnitCost gi·ªØ nguy√™n ƒë·ªÉ ti·ªán nh·∫≠p ti·∫øp
    }

    private void RemoveDetail(ReceiptDetail detail)
    {
        receiptDetailsList.Remove(detail);
    }

    private decimal CalculateTotalCost()
    {
        return receiptDetailsList.Sum(x => x.TotalLineCost);
    }

    private string GetBookTitle(string bookId)
    {
        return books.FirstOrDefault(b => b.Id == bookId)?.Title ?? "Unknown";
    }

    private async Task SaveReceipt()
    {
        if (string.IsNullOrEmpty(newReceipt.SupplierId) || receiptDetailsList.Count == 0)
        {
            // C√≥ th·ªÉ th√™m Toast th√¥ng b√°o l·ªói ·ªü ƒë√¢y
            return;
        }

        // Map d·ªØ li·ªáu v√†o object ch√≠nh
        newReceipt.ReceivingStaffId = "NV-MOCK-ID"; // Gi·∫£ l·∫≠p staff ID
        newReceipt.TotalCost = CalculateTotalCost();
        newReceipt.ReceiptDetails = receiptDetailsList; // ICollection assignment

        await StoreService.CreateReceiptAsync(newReceipt);
        NavManager.NavigateTo("/inventory");
    }
}