@page "/receipts/create"
@layout StoreManagement.Client.Layout.AdminLayout
@using StoreManagement.Client.Models
@using StoreManagement.Client.Services
@using Microsoft.JSInterop
@inject IStoreService StoreService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime

<style>
    /* CSS Bảng nhập liệu */
    .receipt-table th { background-color: #f8f9fa; font-size: 0.85rem; text-transform: uppercase; color: #6c757d; }
    .receipt-table td { vertical-align: middle; }
    .total-display { font-size: 1.5rem; color: #dc3545; font-weight: 800; }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="text-primary fw-bold"><i class="bi bi-file-earmark-plus me-2"></i>Tạo Phiếu Nhập Kho</h3>
    <a href="/inventory" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Quay lại kho
    </a>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card shadow-sm border-0 mb-3">
            <div class="card-header bg-primary text-white fw-bold">
                <i class="bi bi-info-circle me-2"></i>Thông tin chung
            </div>
            <div class="card-body">
                @* 1. Chọn Nhà Cung Cấp *@
                <div class="mb-3">
                    <label class="form-label fw-bold">Nhà cung cấp <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <select class="form-select" @bind="newReceipt.SupplierId">
                            <option value="">-- Chọn nhà cung cấp --</option>
                            @if (suppliers != null)
                            {
                                foreach (var s in suppliers)
                                {
                                    <option value="@s.Id">@s.SupplierName</option>
                                }
                            }
                        </select>
                        <a href="/suppliers" class="btn btn-outline-primary" title="Thêm NCC mới">
                            <i class="bi bi-plus-lg"></i>
                        </a>
                    </div>
                </div>

                @* 2. Ngày nhập *@
                <div class="mb-3">
                    <label class="form-label fw-bold">Ngày nhập:</label>
                    <input type="date" class="form-control" @bind="newReceipt.ReceiptDate" />
                </div>

                <hr />
                
                @* 3. Tổng tiền *@
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-muted">Tổng tiền:</h5>
                    <span class="total-display">@CalculateTotalCost().ToString("N0") đ</span>
                </div>

                @* 4. Nút Lưu *@
                <button class="btn btn-success w-100 mt-4 py-2 fw-bold shadow-sm" @onclick="SaveReceipt">
                    <i class="bi bi-save me-2"></i> LƯU PHIẾU NHẬP
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-light text-dark border-bottom">
                <i class="bi bi-box-seam me-2"></i>Chi tiết sản phẩm nhập
            </div>
            <div class="card-body">
                
                <div class="row g-2 align-items-end mb-4 bg-light p-3 rounded border mx-0">
                    <div class="col-md-5">
                        <label class="small fw-bold mb-1">Sản phẩm:</label>
                        @if (books == null)
                        {
                            <select class="form-select form-select-sm" disabled><option>⏳ Đang tải dữ liệu...</option></select>
                        }
                        else 
                        {
                            <div class="input-group input-group-sm">
                                <select class="form-select" @bind="tempBookId">
                                    <option value="">-- Chọn sách --</option>
                                    @foreach (var b in books)
                                    {
                                        <option value="@b.Id">@b.Title (Tồn: @b.StockQuantity)</option>
                                    }
                                </select>
                                
                                @* Nút reload danh sách (Giữ lại để tiện cập nhật nếu thêm sách ở tab khác) *@
                                <button class="btn btn-outline-primary" @onclick="ReloadBooks" title="Tải lại danh sách">
                                    <i class="bi bi-arrow-repeat"></i>
                                </button>
                            </div>
                            @if(books.Count == 0) { <small class="text-danger">Chưa có sách nào.</small> }
                        }
                    </div>

                    <div class="col-md-2">
                        <label class="small fw-bold mb-1">Số lượng:</label>
                        <input type="number" class="form-control form-select-sm" @bind="tempQty" min="1" placeholder="SL" />
                    </div>
                    
                    <div class="col-md-3">
                        <label class="small fw-bold mb-1">Giá nhập (VNĐ):</label>
                        <input type="number" class="form-control form-select-sm" @bind="tempUnitCost" placeholder="Đơn giá" />
                    </div>
                    
                    <div class="col-md-2">
                        <button class="btn btn-primary btn-sm w-100 fw-bold" @onclick="AddDetail">
                            <i class="bi bi-plus-lg"></i> Thêm
                        </button>
                    </div>
                </div>

                @if (receiptDetailsList.Count == 0)
                {
                    <div class="text-center text-muted py-5 border rounded bg-light border-dashed">
                        <i class="bi bi-cart-x fs-1 d-block mb-2 text-secondary"></i>
                        Chưa có sản phẩm nào trong phiếu.
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover receipt-table mb-0">
                            <thead>
                                <tr>
                                    <th>Tên Sách</th>
                                    <th class="text-center" style="width: 80px;">SL</th>
                                    <th class="text-end" style="width: 130px;">Đơn giá</th>
                                    <th class="text-end" style="width: 150px;">Thành tiền</th>
                                    <th class="text-center" style="width: 60px;">#</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in receiptDetailsList)
                                {
                                    <tr>
                                        <td>
                                            <span class="fw-bold text-dark">@GetBookTitle(item.BookId)</span>
                                        </td>
                                        <td class="text-center">@item.QuantityReceived</td>
                                        <td class="text-end">@item.UnitCost.ToString("N0")</td>
                                        <td class="text-end fw-bold text-primary">@item.TotalLineCost.ToString("N0")</td>
                                        <td class="text-center">
                                            <button class="btn btn-outline-danger btn-sm border-0" @onclick="() => RemoveDetail(item)">
                                                <i class="bi bi-trash-fill"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    // --- BIẾN DỮ LIỆU ---
    private List<Supplier>? suppliers;
    private List<Book>? books;

    // Model
    private InventoryReceipt newReceipt = new InventoryReceipt { ReceiptDate = DateTime.Now };
    private List<ReceiptDetail> receiptDetailsList = new List<ReceiptDetail>();

    // Biến trạng thái
    private string tempBookId = "";
    private int tempQty = 1;
    private decimal tempUnitCost = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        suppliers = await StoreService.GetSuppliersAsync();
        books = await StoreService.GetBooksAsync();
    }

    private async Task ReloadBooks()
    {
        books = null; // Hiện loading
        StateHasChanged();
        await Task.Delay(300);
        books = await StoreService.GetBooksAsync();
        StateHasChanged();
    }

    // --- LOGIC NHẬP KHO ---
    private void AddDetail()
    {
        if (string.IsNullOrEmpty(tempBookId) || tempQty <= 0 || tempUnitCost <= 0) return;

        var existing = receiptDetailsList.FirstOrDefault(x => x.BookId == tempBookId && x.UnitCost == tempUnitCost);
        if (existing != null)
        {
            existing.QuantityReceived += tempQty;
            existing.TotalLineCost = existing.QuantityReceived * existing.UnitCost;
        }
        else
        {
            receiptDetailsList.Add(new ReceiptDetail
            {
                BookId = tempBookId,
                QuantityReceived = tempQty,
                UnitCost = tempUnitCost,
                TotalLineCost = tempQty * tempUnitCost
            });
        }
        tempQty = 1;
    }

    private void RemoveDetail(ReceiptDetail detail) => receiptDetailsList.Remove(detail);
    private decimal CalculateTotalCost() => receiptDetailsList.Sum(x => x.TotalLineCost);
    private string GetBookTitle(string bookId) => books?.FirstOrDefault(b => b.Id == bookId)?.Title ?? "Unknown";

    private async Task SaveReceipt()
    {
        if (string.IsNullOrEmpty(newReceipt.SupplierId) || receiptDetailsList.Count == 0)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Vui lòng chọn NCC và nhập ít nhất 1 sản phẩm!");
            return;
        }

        newReceipt.ReceiptDetails = receiptDetailsList;
        newReceipt.TotalCost = CalculateTotalCost();

        bool success = await StoreService.CreateReceiptAsync(newReceipt);

        if (success)
        {
            await JSRuntime.InvokeVoidAsync("alert", "✅ Nhập kho thành công!");
            NavManager.NavigateTo("/inventory");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "❌ Lỗi khi lưu phiếu. Vui lòng thử lại!");
        }
    }
}