@page "/publishers"
@layout StoreManagement.Client.Layout.AdminLayout
@using StoreManagement.Client.Models
@using StoreManagement.Client.Services
@inject IStoreService StoreService
@inject IJSRuntime JSRuntime

<style>
    :root { --primary: #4e73df; --bg-light: #f8f9fc; }
    body { background-color: var(--bg-light); }
    
    .custom-card { border: none; border-radius: 12px; box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15); background: white; }
    .table thead th { background-color: #f8f9fc; color: #4e73df; border-bottom: 2px solid #e3e6f0; }
    
    /* Modal */
    .modal-backdrop-custom { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; display: flex; align-items: center; justify-content: center; }
    .modal-content-custom { background: white; border-radius: 15px; width: 95%; max-width: 500px; animation: slideDown 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .modal-header-custom { background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); color: white; padding: 15px 25px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
    
    @@keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { opacity: 1; transform: translateY(0); } }
    
    .publisher-code { font-family: monospace; font-weight: bold; color: #e74a3b; background: #fdf2f2; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; }
</style>

<div class="container-fluid p-0">
    <h3 class="fw-bold mb-4 mt-2" style="color: #4e73df"><i class="bi bi-building me-2"></i>Quản lý Nhà Xuất Bản</h3>

    <div class="custom-card mb-4">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between mb-4">
                <div class="input-group shadow-sm" style="max-width: 350px;">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" 
                           placeholder="Tìm theo tên hoặc mã..." 
                           @bind="searchText" @bind:event="oninput" />
                </div>
                <button class="btn btn-primary fw-bold shadow-sm px-4 rounded-pill" @onclick="OpenCreateModal">
                    <i class="bi bi-plus-lg me-1"></i> Thêm Mới
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th style="width: 35%">Tên Nhà Xuất Bản</th>
                            <th style="width: 20%">Mã NXB (Code)</th>
                            <th style="width: 30%">Địa Chỉ</th>
                            <th style="width: 15%" class="text-end">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (VisiblePublishers != null)
                        {
                            @foreach (var p in VisiblePublishers)
                            {
                                <tr>
                                    <td>
                                        <div class="fw-bold text-dark">@p.Name</div>
                                    </td>
                                    <td>
                                        <span class="publisher-code">@p.Code</span>
                                    </td>
                                    <td class="text-secondary small">
                                        <i class="bi bi-geo-alt-fill me-1 text-danger"></i> @p.Address
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-primary border-0 bg-light me-1" @onclick="() => OpenEditModal(p)" title="Sửa"><i class="bi bi-pencil-square fs-6"></i></button>
                                        <button class="btn btn-sm btn-outline-danger border-0 bg-light" @onclick="() => DeletePublisher(p)" title="Xóa"><i class="bi bi-trash fs-6"></i></button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@if (showModal)
{
    <div class="modal-backdrop-custom" @onclick="CloseModal">
        <div class="modal-content-custom" @onclick:stopPropagation="true">
            <div class="modal-header-custom">
                <h5 class="mb-0 fw-bold">@(string.IsNullOrEmpty(currentPublisher.Id) ? "✨ Thêm Mới" : "✏️ Cập Nhật")</h5>
                <button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
            </div>
            <div class="modal-body p-4">
                <EditForm Model="currentPublisher" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    @* Mã Code *@
                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small">Mã NXB (Code) <span class="text-danger">*</span></label>
                        <InputText class="form-control text-uppercase fw-bold" @bind-Value="currentPublisher.Code" />
                    </div>

                    @* Tên *@
                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small">Tên Nhà Xuất Bản <span class="text-danger">*</span></label>
                        <InputText class="form-control" @bind-Value="currentPublisher.Name" />
                    </div>

                    @* Địa chỉ *@
                    <div class="mb-3">
                        <label class="form-label fw-bold text-secondary small">Địa chỉ</label>
                        <InputTextArea class="form-control" @bind-Value="currentPublisher.Address" rows="3" placeholder="Nhập địa chỉ..." />
                    </div>

                    <div class="text-end pt-3 border-top">
                        <button type="button" class="btn btn-light me-2" @onclick="CloseModal">Hủy bỏ</button>
                        <button type="submit" class="btn btn-primary fw-bold px-4">
                            <i class="bi bi-save me-1"></i> Lưu Lại
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@code {
    private List<Publisher>? publishers;
    private Publisher currentPublisher = new();
    private bool showModal = false;
    private string searchText = "";

    protected override async Task OnInitializedAsync() => await LoadData();
    private async Task LoadData() => publishers = await StoreService.GetPublishersAsync();

    private IEnumerable<Publisher> VisiblePublishers => 
        publishers?.Where(p => 
            (p.Name?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (p.Code?.Contains(searchText, StringComparison.OrdinalIgnoreCase) ?? false)
        ) ?? new List<Publisher>();

    private void OpenCreateModal() { currentPublisher = new Publisher(); currentPublisher.Id = string.Empty; showModal = true; }
    
    private void OpenEditModal(Publisher p) 
    { 
        currentPublisher = new Publisher { Id = p.Id, Name = p.Name, Code = p.Code, Address = p.Address, Status = p.Status }; 
        showModal = true; 
    }
    
    private void CloseModal() => showModal = false;

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(currentPublisher.Name) || string.IsNullOrWhiteSpace(currentPublisher.Code)) return;
        
        if (string.IsNullOrEmpty(currentPublisher.Id)) 
            await StoreService.CreatePublisherAsync(currentPublisher);
        else 
            await StoreService.UpdatePublisherAsync(currentPublisher);
            
        showModal = false; 
        await LoadData();
    }

    private async Task DeletePublisher(Publisher p)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Xóa NXB '{p.Name}'?")) 
        {
            await StoreService.DeletePublisherAsync(p.Id); 
            await LoadData();
        }
    }
}