@page "/vouchers"
@layout StoreManagement.Client.Layout.AdminLayout
@using StoreManagement.Client.Models
@using StoreManagement.Client.Services
@inject IStoreService StoreService
@inject IJSRuntime JSRuntime

<style>
    /* Bi·∫øn m√†u s·∫Øc */
    :root { --v-primary: #f6c23e; --v-bg: #f8f9fc; }
    body { background-color: var(--v-bg); font-family: 'Segoe UI', sans-serif; }

    /* TABLE STYLE */
    .table-container { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; }
    .table thead th { background-color: #f8f9fc; border-bottom: 2px solid #e3e6f0; color: #5a5c69; font-weight: 700; text-transform: uppercase; font-size: 0.85rem; padding: 15px; }
    .table tbody td { padding: 15px; vertical-align: middle; color: #5a5c69; border-bottom: 1px solid #e3e6f0; }
    .table-hover tbody tr:hover { background-color: #fff8e1; }

    .voucher-code-badge { font-family: 'Courier New', monospace; font-weight: 800; color: #d68c08; background: #fdf3d8; padding: 5px 10px; border-radius: 6px; border: 1px dashed #d68c08; }
    
    /* MODAL STYLE */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: flex; justify-content: center; align-items: center; z-index: 2000; animation: fadeIn 0.3s ease-out; }
    .custom-modal { background: white; width: 700px; max-width: 95%; border-radius: 16px; box-shadow: 0 15px 35px rgba(0,0,0,0.25); display: flex; flex-direction: column; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    .modal-header { background: linear-gradient(135deg, #f6c23e 0%, #e0a800 100%); padding: 20px 25px; color: white; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 25px; overflow-y: auto; max-height: 75vh; }
    .modal-footer { padding: 15px 25px; background: #f8f9fc; text-align: right; }

    .modern-input { border-radius: 10px; padding: 10px; border: 1px solid #d1d3e2; }
    .modern-input:focus { border-color: #f6c23e; box-shadow: 0 0 0 0.2rem rgba(246, 194, 62, 0.25); }

    /* SUGGESTION LIST */
    .suggestion-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; z-index: 1050; box-shadow: 0 4px 10px rgba(0,0,0,0.1); list-style: none; padding: 0; margin: 0; }
    .suggestion-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
    .suggestion-item:hover { background-color: #f8f9fc; color: #4e73df; }

    /* ANIMATION */
    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="container-fluid p-0">
    @* HEADER & T√åM KI·∫æM *@
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 style="font-weight: 800; color: #5a5c69;">üéüÔ∏è Qu·∫£n L√Ω Khuy·∫øn M√£i</h3>
        
        <div class="d-flex gap-2">
            <div class="input-group shadow-sm" style="width: 350px;">
                <input type="text" class="form-control border-end-0" 
                       placeholder="Nh·∫≠p t√™n ho·∫∑c m√£..." 
                       @bind="searchTerm" @bind:event="oninput" @onkeyup="HandleEnterKey" />
                <button class="btn btn-primary fw-bold px-4" type="button" @onclick="SearchData">
                    <i class="bi bi-search me-2"></i>T√¨m
                </button>
            </div>

            <button class="btn btn-warning text-white fw-bold shadow-sm px-4 rounded-pill" @onclick="ShowCreateForm">
                <i class="bi bi-plus-lg me-1"></i> T·∫°o Voucher
            </button>
        </div>
    </div>

    @* TABLE VIEW *@
    @if (vouchers == null)
    {
        <div class="text-center mt-5"><div class="spinner-border text-warning"></div><p class="mt-2 text-muted">ƒêang t·∫£i...</p></div>
    }
    else if (!VisibleVouchers.Any())
    {
        <div class="alert alert-light text-center border shadow-sm py-4">
            <i class="bi bi-search fs-1 text-muted mb-2 d-block"></i>
            Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o ph√π h·ª£p.
        </div>
    }
    else
    {
        <div class="table-container">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th style="width: 15%;">M√£ Code</th>
                        <th style="width: 25%;">T√™n Ch∆∞∆°ng Tr√¨nh</th>
                        <th style="width: 15%;" class="text-end">Gi√° Tr·ªã</th>
                        <th style="width: 15%;" class="text-center">Th·ªùi Gian</th>
                        <th style="width: 15%;" class="text-center">Tr·∫°ng Th√°i</th>
                        <th style="width: 15%;" class="text-end">H√†nh ƒê·ªông</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var v in VisibleVouchers)
                    {
                        <tr>
                            <td>
                                <span class="voucher-code-badge">@v.VoucherCode</span>
                            </td>
                            <td>
                                <div class="fw-bold text-dark">@v.VoucherName</div>
                                <small class="text-muted" style="font-size: 0.8rem;">
                                    @(v.VoucherType == "Percentage" ? "Gi·∫£m theo %" : "Gi·∫£m ti·ªÅn m·∫∑t")
                                </small>
                            </td>
                            <td class="text-end">
                                <span class="fw-bold text-danger" style="font-size: 1.1rem;">
                                    @(v.VoucherType == "Percentage" ? $"-{v.DiscountValue}%" : $"-{v.DiscountValue:N0} ƒë")
                                </span>
                            </td>
                            <td class="text-center small text-muted">
                                <div>@v.StartDate.ToString("dd/MM/yyyy")</div>
                                <div><i class="bi bi-arrow-down-short"></i></div>
                                <div>@v.EndDate.ToString("dd/MM/yyyy")</div>
                            </td>
                            <td class="text-center">
                                @if (v.IsActive)
                                {
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success px-3 py-2 rounded-pill">Ho·∫°t ƒë·ªông</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary px-3 py-2 rounded-pill">ƒê√£ t·∫Øt</span>
                                }
                            </td>
                            <td class="text-end">
                                <button class="btn btn-warning text-dark fw-bold me-2 shadow-sm" 
                                        @onclick="() => ShowEditForm(v)" title="S·ª≠a">
                                    <i class="bi bi-pencil-square me-1"></i> S·ª≠a
                                </button>
                                <button class="btn btn-danger fw-bold shadow-sm" 
                                        @onclick="() => DeleteVoucher(v.Id)" title="X√≥a">
                                    <i class="bi bi-trash me-1"></i> X√≥a
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@* MODAL FORM *@
@if (showForm)
{
    <div class="modal-overlay" @onclick="CloseFormOutside">
        <div class="custom-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h5 class="mb-0 fw-bold text-white">@(string.IsNullOrEmpty(currentVoucher.Id) ? "‚ú® T·∫°o Voucher M·ªõi" : "‚úèÔ∏è C·∫≠p Nh·∫≠t Voucher")</h5>
                <button class="btn-close btn-close-white" @onclick="CancelForm"></button>
            </div>
            <div class="modal-body">
                <EditForm id="voucherForm" Model="currentVoucher" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    @* --- PH·∫¶N 1: TH√îNG TIN C∆† B·∫¢N --- *@
                    <h6 class="text-secondary fw-bold mb-3"><i class="bi bi-info-circle me-2"></i>Th√¥ng tin chung</h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">M√£ Code (*)</label>
                            <InputText class="form-control modern-input text-uppercase fw-bold" @bind-Value="currentVoucher.VoucherCode" placeholder="VD: SALE50" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">T√™n Voucher (*)</label>
                            <InputText class="form-control modern-input" @bind-Value="currentVoucher.VoucherName" placeholder="VD: Khuy·∫øn m√£i m√πa h√®" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Lo·∫°i gi·∫£m gi√°</label>
                            <InputSelect class="form-select modern-input" @bind-Value="currentVoucher.VoucherType">
                                <option value="Percentage">Ph·∫ßn trƒÉm (%)</option>
                                <option value="Fixed">Ti·ªÅn m·∫∑t (VNƒê)</option>
                            </InputSelect>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Gi√° tr·ªã gi·∫£m</label>
                            <InputNumber class="form-control modern-input" @bind-Value="currentVoucher.DiscountValue" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Ng√†y b·∫Øt ƒë·∫ßu</label>
                            <InputDate class="form-control modern-input" @bind-Value="currentVoucher.StartDate" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Ng√†y k·∫øt th√∫c</label>
                            <InputDate class="form-control modern-input" @bind-Value="currentVoucher.EndDate" />
                        </div>
                    </div>

                    <hr class="my-3"/>

                    @* --- PH·∫¶N 2: PH·∫†M VI √ÅP D·ª§NG (TARGET) --- *@
                    <h6 class="text-secondary fw-bold mb-3"><i class="bi bi-bullseye me-2"></i>Ph·∫°m vi √°p d·ª•ng</h6>
                    
                    <div class="mb-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="targetType" 
                                   id="typeProduct" value="PRODUCT_TARGET" 
                                   @onchange="@(() => ChangeTargetType("PRODUCT_TARGET"))" 
                                   checked="@(selectedTargetType == "PRODUCT_TARGET")">
                            <label class="form-check-label fw-bold" for="typeProduct">Theo S·∫£n Ph·∫©m</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="targetType" 
                                   id="typeCategory" value="CATEGORY_TARGET" 
                                   @onchange="@(() => ChangeTargetType("CATEGORY_TARGET"))"
                                   checked="@(selectedTargetType == "CATEGORY_TARGET")">
                            <label class="form-check-label fw-bold" for="typeCategory">Theo Danh M·ª•c</label>
                        </div>
                    </div>

                    <div class="mb-3 position-relative">
                        @if (selectedTargetType == "PRODUCT_TARGET")
                        {
                            <label class="form-label small text-muted">G√µ t√™n s√°ch ƒë·ªÉ t√¨m ki·∫øm:</label>
                            <input type="text" class="form-control modern-input" 
                                   placeholder="V√≠ d·ª•: ƒê·∫Øc nh√¢n t√¢m..." 
                                   @bind="targetSearchTerm" @oninput="OnSearchTargetInput" />
                            
                            @if (suggestedBooks.Any())
                            {
                                <ul class="suggestion-list">
                                    @foreach (var book in suggestedBooks)
                                    {
                                        <li class="suggestion-item" @onclick="() => SelectBook(book)">
                                            <div class="fw-bold">@book.Title</div>
                                            <small class="text-muted">ISBN: @book.Isbn</small>
                                        </li>
                                    }
                                </ul>
                            }
                        }
                        else
                        {
                            <label class="form-label small text-muted">Ch·ªçn danh m·ª•c:</label>
                            <select class="form-select modern-input" @onchange="SelectCategory">
                                <option value="">-- Ch·ªçn danh m·ª•c --</option>
                                @foreach (var cat in allCategories)
                                {
                                    <option value="@cat.Id">@cat.CategoryName</option>
                                }
                            </select>
                        }
                    </div>

                    @* Hi·ªÉn th·ªã c√°c m·ª•c ƒë√£ ch·ªçn (Badges) *@
                    @if (selectedTargetNames.Any())
                    {
                        <div class="d-flex flex-wrap gap-2 p-2 bg-light rounded border">
                            @for (int i = 0; i < selectedTargetNames.Count; i++)
                            {
                                var index = i;
                                <span class="badge bg-white text-dark border shadow-sm d-flex align-items-center px-3 py-2">
                                    @selectedTargetNames[i]
                                    <i class="bi bi-x-circle-fill text-danger ms-2 cursor-pointer" 
                                       style="cursor: pointer;" @onclick="() => RemoveTarget(index)"></i>
                                </span>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted small fst-italic">Ch∆∞a ch·ªçn m·ª•c ti√™u n√†o.</p>
                    }

                    <div class="form-check mt-3 pt-3 border-top">
                        <InputCheckbox class="form-check-input" @bind-Value="currentVoucher.IsActive" id="activeChk" style="width: 1.3em; height: 1.3em;" />
                        <label class="form-check-label fw-bold ms-2 pt-1" for="activeChk">K√≠ch ho·∫°t ngay</label>
                    </div>

                </EditForm>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light fw-bold text-secondary" @onclick="CancelForm">H·ªßy b·ªè</button>
                <button type="submit" form="voucherForm" class="btn btn-warning text-white fw-bold px-4">L∆∞u L·∫°i</button>
            </div>
        </div>
    </div>
}

@code {
    private List<Voucher>? vouchers;
    private bool showForm = false;
    private Voucher currentVoucher = new Voucher();

    // --- Bi·∫øn T√¨m ki·∫øm ---
    private string searchTerm = "";

    // --- Bi·∫øn Target ---
    private List<Book> suggestedBooks = new();
    private List<Category> allCategories = new();
    private List<string> selectedTargetIds = new();
    private List<string> selectedTargetNames = new();
    private string targetSearchTerm = "";
    private string selectedTargetType = "PRODUCT_TARGET"; 

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }
    private async Task SearchData()
    {
        await LoadData();
    }
    private async Task HandleEnterKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SearchData();
        }
    }
    private async Task LoadData() => vouchers = await StoreService.GetVouchersAsync();

    // --- LOGIC L·ªåC T·∫†I CLIENT (M∆∞·ª£t m√†, kh√¥ng c·∫ßn g·ªçi API Search) ---
    private IEnumerable<Voucher> VisibleVouchers
    {
        get
        {
            if (vouchers == null) return Enumerable.Empty<Voucher>();
            if (string.IsNullOrWhiteSpace(searchTerm)) return vouchers;

            return vouchers.Where(v => 
                (v.VoucherName?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (v.VoucherCode?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)
            );
        }
    }

    // --- LOGIC FORM ---

    private async void ShowCreateForm()
    {
        currentVoucher = new Voucher { StartDate = DateTime.Now, EndDate = DateTime.Now.AddDays(7), VoucherType = "Percentage", IsActive = true };
        currentVoucher.Id = string.Empty; // Reset ID = Create
        
        // Reset Target
        selectedTargetIds.Clear();
        selectedTargetNames.Clear();
        targetSearchTerm = "";
        selectedTargetType = "PRODUCT_TARGET";
        
        allCategories = await StoreService.GetAllCategoriesAsync();
        
        showForm = true;
        StateHasChanged();
    }

    private async void ShowEditForm(Voucher v)
    {
        currentVoucher = new Voucher 
        { 
            Id = v.Id, VoucherCode = v.VoucherCode, VoucherName = v.VoucherName,
            DiscountValue = v.DiscountValue, StartDate = v.StartDate, EndDate = v.EndDate, IsActive = v.IsActive,
            VoucherType = v.VoucherType
        };
        
        selectedTargetIds.Clear();
        selectedTargetNames.Clear();
        allCategories = await StoreService.GetAllCategoriesAsync();

        showForm = true;
        StateHasChanged();
    }

    private void CancelForm() => showForm = false;
    private void CloseFormOutside() => showForm = false;

    // --- LOGIC TARGET & SUGGESTION ---

    private void ChangeTargetType(string type)
    {
        selectedTargetType = type;
        selectedTargetIds.Clear();
        selectedTargetNames.Clear();
        targetSearchTerm = "";
        suggestedBooks.Clear();
    }

    private async Task OnSearchTargetInput(ChangeEventArgs e)
    {
        targetSearchTerm = e.Value?.ToString() ?? "";
        if (targetSearchTerm.Length > 1) 
            suggestedBooks = await StoreService.SearchBooksAsync(targetSearchTerm);
        else
            suggestedBooks.Clear();
    }

    private void SelectBook(Book book)
    {
        if (!selectedTargetIds.Contains(book.Id))
        {
            selectedTargetIds.Add(book.Id);
            selectedTargetNames.Add(book.Title);
        }
        targetSearchTerm = "";
        suggestedBooks.Clear();
    }

    private void SelectCategory(ChangeEventArgs e)
    {
        var catId = e.Value?.ToString();
        var cat = allCategories.FirstOrDefault(c => c.Id == catId);
        if (cat != null && !selectedTargetIds.Contains(cat.Id))
        {
            selectedTargetIds.Add(cat.Id);
            selectedTargetNames.Add(cat.CategoryName);
        }
    }

    private void RemoveTarget(int index)
    {
        if (index >= 0 && index < selectedTargetIds.Count)
        {
            selectedTargetIds.RemoveAt(index);
            selectedTargetNames.RemoveAt(index);
        }
    }

    // --- SUBMIT ---

    private async Task HandleSubmit()
    {
        // G·ª≠i danh s√°ch Target k√®m theo Voucher (B·∫°n c·∫ßn ƒë·∫£m b·∫£o Service ƒë√£ h·ªó tr·ª£)
        // Hi·ªán t·∫°i code Service tr∆∞·ªõc ƒë√≥ ta ƒë√£ s·ª≠a nh·∫≠n TargetIds ch∆∞a? N·∫øu ch∆∞a th√¨ ch·ªâ g·ª≠i Voucher c∆° b·∫£n.
        
        if (string.IsNullOrEmpty(currentVoucher.Id))
            await StoreService.CreateVoucherAsync(currentVoucher); 
        else
            await StoreService.UpdateVoucherAsync(currentVoucher);
        
        showForm = false;
        await LoadData();
    }

    private async Task DeleteVoucher(string id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a Voucher n√†y kh√¥ng?"))
        {
            await StoreService.DeleteVoucherAsync(id);
            await LoadData();
        }
    }
}