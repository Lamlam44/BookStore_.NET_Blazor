@page "/vouchers"
@using StoreManagement.Client.Models
@using StoreManagement.Client.Services
@inject IStoreService StoreService
@inject IJSRuntime JSRuntime

<style>
    /* --- Overlay n·ªÅn m·ªù --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.55); /* M√†u ƒëen m·ªù */
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000; /* ƒê·∫£m b·∫£o n·∫±m tr√™n c√πng */
    }

    /* --- Khung popup --- */
    .custom-modal {
        background: white;
        width: 650px;
        max-width: 90%;
        border-radius: 12px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.3);
        animation: popupShow 0.25s ease-out;
        display: flex;
        flex-direction: column;
    }

    /* Hi·ªáu ·ª©ng hi·ªán ra t·ª´ t·ª´ */
    @@keyframes popupShow {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
    }

    .modal-header {
        border-bottom: 1px solid #ddd;
        padding: 15px 20px;
        background: #198754; /* M√†u xanh success */
        color: white;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 20px;
        max-height: 70vh; /* Gi·ªõi h·∫°n chi·ªÅu cao n·∫øu m√†n h√¨nh nh·ªè */
        overflow-y: auto;
    }

    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #ddd;
        text-align: right;
        background: #f8f9fa;
        border-radius: 0 0 12px 12px;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>üéüÔ∏è Qu·∫£n L√Ω Khuy·∫øn M√£i</h3>
    <button class="btn btn-success" @onclick="ShowCreateForm">
        <i class="bi bi-plus-lg"></i> Th√™m Voucher M·ªõi
    </button>
</div>

@* --- DANH S√ÅCH VOUCHER --- *@
@if (vouchers == null)
{
    <div class="text-center mt-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>
}
else if (vouchers.Count == 0)
{
    <div class="alert alert-warning text-center mt-4">
        <i class="bi bi-inbox fs-4"></i> <br/>
        Ch∆∞a c√≥ m√£ gi·∫£m gi√° n√†o. H√£y t·∫°o m·ªõi ngay!
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle shadow-sm border bg-white">
            <thead class="table-light">
                <tr>
                    <th>M√£ Code</th>
                    <th>T√™n Voucher</th>
                    <th class="text-end">Gi√° tr·ªã</th>
                    <th class="text-center">Th·ªùi gian</th>
                    <th class="text-center">Tr·∫°ng th√°i</th>
                    <th class="text-end">H√†nh ƒë·ªông</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var v in vouchers)
                {
                    <tr>
                        @* 1. M√£ Code *@
                        <td>
                            <span class="badge bg-warning text-dark" style="font-size: 0.9rem;">
                                @v.VoucherCode
                            </span>
                        </td>

                        @* 2. T√™n Voucher *@
                        <td class="fw-bold text-primary">
                            @v.VoucherName
                        </td>

                        @* 3. Gi√° tr·ªã (T·ª± ƒë·ªông hi·ªán % ho·∫∑c ƒë) *@
                        <td class="text-end fw-bold text-danger">
                            @(v.VoucherType == "Percentage" ? $"-{v.DiscountValue}%" : $"-{v.DiscountValue:N0} ƒë")
                        </td>

                        @* 4. Th·ªùi gian *@
                        <td class="text-center small text-muted">
                            @v.StartDate.ToString("dd/MM/yyyy") 
                            <i class="bi bi-arrow-right-short mx-1"></i> 
                            @v.EndDate.ToString("dd/MM/yyyy")
                        </td>

                        @* 5. Tr·∫°ng th√°i *@
                        <td class="text-center">
                            @if (v.IsActive)
                            {
                                <span class="badge bg-success rounded-pill">Ho·∫°t ƒë·ªông</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary rounded-pill">ƒê√£ t·∫Øt</span>
                            }
                        </td>

                        @* 6. H√†nh ƒë·ªông *@
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => ShowEditForm(v)" title="S·ª≠a">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteVoucher(v.Id)" title="X√≥a">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@* --- POPUP FORM (MODAL) --- *@
@if (showForm)
{
    <div class="modal-overlay" @onclick="CloseFormOutside">
        <div class="custom-modal" @onclick:stopPropagation="true">

            <div class="modal-header">
                <h5 class="mb-0">
                    @(string.IsNullOrEmpty(currentVoucher.Id) ? "‚ú® T·∫°o Voucher M·ªõi" : "‚úèÔ∏è C·∫≠p Nh·∫≠t Voucher")
                </h5>
                <button type="button" class="btn-close btn-close-white" @onclick="CancelForm"></button>
            </div>

            <div class="modal-body">
                <EditForm id="voucherForm" Model="currentVoucher" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">M√£ Code (*)</label>
                            <InputText class="form-control text-uppercase fw-bold" @bind-Value="currentVoucher.VoucherCode" placeholder="VD: SUMMER2025" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">T√™n Voucher (*)</label>
                            <InputText class="form-control" @bind-Value="currentVoucher.VoucherName" placeholder="VD: Gi·∫£m gi√° m√πa h√®" />
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Lo·∫°i gi·∫£m gi√°</label>
                            <InputSelect class="form-select" @bind-Value="currentVoucher.VoucherType">
                                <option value="Percentage">Ph·∫ßn trƒÉm (%)</option>
                                <option value="Fixed">Ti·ªÅn m·∫∑t (VNƒê)</option>
                            </InputSelect>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Gi√° tr·ªã gi·∫£m</label>
                            <InputNumber class="form-control" @bind-Value="currentVoucher.DiscountValue" />
                        </div>

                        <div class="col-md-6 mb-3 d-flex align-items-end">
                             <div class="form-check mb-2">
                                <InputCheckbox class="form-check-input" @bind-Value="currentVoucher.IsActive" id="activeChk" />
                                <label class="form-check-label" for="activeChk">ƒêang k√≠ch ho·∫°t</label>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
                            <InputDate class="form-control" @bind-Value="currentVoucher.StartDate" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ng√†y k·∫øt th√∫c</label>
                            <InputDate class="form-control" @bind-Value="currentVoucher.EndDate" />
                        </div>
                    </div>
                </EditForm>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary me-2" @onclick="CancelForm">H·ªßy b·ªè</button>
                <button type="submit" form="voucherForm" class="btn btn-success">
                    <i class="bi bi-save"></i> L∆∞u th√¥ng tin
                </button>
            </div>

        </div>
    </div>
}

@code {
    private List<Voucher>? vouchers;
    private bool showForm = false;
    private Voucher currentVoucher = new Voucher();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData() => vouchers = await StoreService.GetVouchersAsync();

    // --- LOGIC FORM ---

    private void ShowCreateForm()
    {
        currentVoucher = new Voucher 
        { 
            StartDate = DateTime.Now, EndDate = DateTime.Now.AddDays(7), 
            VoucherType = "Percentage", IsActive = true 
        };
        currentVoucher.Id = string.Empty;
        showForm = true;
    }

    private void ShowEditForm(Voucher v)
    {
        // Clone object
        currentVoucher = new Voucher
        {
            Id = v.Id, VoucherCode = v.VoucherCode, VoucherType = v.VoucherType,
            DiscountValue = v.DiscountValue, StartDate = v.StartDate, EndDate = v.EndDate, IsActive = v.IsActive
        };
        showForm = true;
    }

    private void CancelForm() => showForm = false;

    // H√†m ƒë√≥ng form khi click ra v√πng t·ªëi b√™n ngo√†i
    private void CloseFormOutside() => showForm = false;

    private async Task HandleSubmit()
    {
        if (string.IsNullOrEmpty(currentVoucher.Id))
            await StoreService.CreateVoucherAsync(currentVoucher);
        else
            await StoreService.UpdateVoucherAsync(currentVoucher);

        showForm = false;
        await LoadData();
    }

    private async Task DeleteVoucher(string id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a Voucher n√†y kh√¥ng?"))
        {
            await StoreService.DeleteVoucherAsync(id);
            await LoadData();
        }
    }
}