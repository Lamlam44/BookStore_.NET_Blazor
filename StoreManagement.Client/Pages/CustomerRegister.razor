@page "/customer-register"
@layout EmptyLayout
@inject StoreManagement.Client.Services.ApiService ApiService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthProvider
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<div class="container py-5 h-100">
    <div class="row d-flex justify-content-center align-items-center h-100">
        <div class="col-12 col-md-8 col-lg-6 col-xl-5">
            <div class="card shadow border-0" style="border-radius: 1rem;">
                <div class="card-body p-5">
                    <h3 class="text-center mb-4 text-primary fw-bold">Đăng Ký Tài Khoản</h3>

                    <EditForm Model="regModel" OnValidSubmit="HandleRegistration">
                        <DataAnnotationsValidator />

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">@errorMessage</div>
                        }

                        <div class="mb-3">
                            <label class="form-label">Họ và tên</label>
                            <InputText class="form-control" @bind-Value="regModel.Name" />
                            <ValidationMessage For="@(() => regModel.Name)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <InputText type="email" class="form-control" @bind-Value="regModel.Email" />
                            <ValidationMessage For="@(() => regModel.Email)" />
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Số điện thoại</label>
                            <InputText class="form-control" @bind-Value="regModel.Phone" />
                            <ValidationMessage For="@(() => regModel.Phone)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Địa chỉ</label>
                            <InputText class="form-control" @bind-Value="regModel.Address" />
                            <ValidationMessage For="@(() => regModel.Address)" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Mật khẩu</label>
                            <InputText type="password" class="form-control" @bind-Value="regModel.Password" />
                            <ValidationMessage For="@(() => regModel.Password)" />
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-success btn-lg">Đăng Ký</button>
                        </div>
                    </EditForm>
                </div>
                <div class="card-footer text-center py-3">
                    <small>Đã có tài khoản? <a href="login" class="fw-bold text-decoration-none">Đăng nhập</a></small>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // ... Giữ nguyên phần Code C# cũ của bạn ở đây ...
    // Copy lại phần @code từ file CustomerRegister.razor cũ của bạn
    // Vì logic đăng ký của bạn đã ổn.
    
    private class RegistrationModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string Name { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.EmailAddress]
        public string Email { get; set; } = "";
        
        [System.ComponentModel.DataAnnotations.Required]
        public string Phone { get; set; } = "";
        
        [System.ComponentModel.DataAnnotations.Required]
        public string Address { get; set; } = "";

        [System.ComponentModel.DataAnnotations.Required]
        [System.ComponentModel.DataAnnotations.MinLength(6, ErrorMessage = "Mật khẩu phải từ 6 ký tự.")]
        public string Password { get; set; } = "";
    }

    private RegistrationModel regModel = new();
    private string? errorMessage;

    private async Task HandleRegistration()
    {
        errorMessage = null;
        var customerToRegister = new Customer
        {
            Name = regModel.Name,
            Email = regModel.Email,
            Phone = regModel.Phone,
            Address = regModel.Address
        };

        var response = await ApiService.CustomerRegisterAsync(customerToRegister, regModel.Password);

        if (response.Success && response.Data != null && !string.IsNullOrWhiteSpace(response.Data.AccessToken))
        {
            var customAuthProvider = (StoreManagement.Client.Services.CustomAuthenticationStateProvider)AuthProvider;
            await customAuthProvider.MarkUserAsAuthenticated(response.Data.AccessToken);

            // Also create customer profile record on backend (if needed)
            var createCus = await ApiService.CreateCustomerAsync(customerToRegister.Name, customerToRegister.Phone, customerToRegister.Address);
            // If backend created/returned a customer record, persist the CustomerId locally so checkout can use it
            if (createCus.Success && createCus.Data != null && !string.IsNullOrWhiteSpace(createCus.Data.Id))
            {
                await LocalStorage.SetItemAsync("customerId", createCus.Data.Id);
            }

            NavigationManager.NavigateTo("/"); // Đăng ký xong về trang chủ
        }
        else
        {
            errorMessage = response.Message ?? "Đăng ký thất bại.";
        }
    }
}