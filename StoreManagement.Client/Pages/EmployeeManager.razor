@page "/employees"
@using StoreManagement.Client.Models
@using StoreManagement.Client.Services
@inject IJSRuntime JSRuntime
@inject ApiService ApiService

<h3 class="mb-4">Quản lý Nhân viên</h3>

<div class="row mb-3">
    <div class="col">
        <button class="btn btn-primary" @onclick="OpenAddEmployeeModal">
            <i class="oi oi-plus"></i> Thêm nhân viên
        </button>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header">
        <h5 class="mb-0">Danh sách Nhân viên</h5>
    </div>
    <div class="card-body">
        <table class="table table-hover">
            <thead class="table-light">
                <tr>
                    <th>Họ tên</th>
                    <th>Ngày sinh</th>
                    <th>SĐT</th>
                    <th>Vị trí</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (employees == null)
                {
                    <tr><td colspan="8" class="text-center"><i>Đang tải...</i></td></tr>
                }
                else
                {
                    @foreach (var emp in employees)
                    {
                        <tr>
                            <td>@emp.Name</td>
                            <td>@emp.DateOfBirth?.ToString("dd/MM/yyyy")</td>
                            <td>@emp.Phone</td>
                            <td>@emp.Position</td>
                            <td>@emp.Account.Username</td>
                            <td><span class="badge bg-info">@emp.Account.Role</span></td>
                            <td>
                                <span class="badge @(emp.Account.IsActive ? "bg-success" : "bg-secondary")">
                                    @(emp.Account.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => OpenEditEmployeeModal(emp)">
                                    <i class="oi oi-pencil"></i> Sửa
                                </button>
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteEmployee(emp)">
                                    <i class="oi oi-trash"></i> Xóa
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Employee Modal -->
<div class="modal fade" id="employeeModal" tabindex="-1" aria-labelledby="employeeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="employeeModalLabel">@modalTitle</h5>
                <button type="button" class="btn-close" @onclick="CloseModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <EditForm Model="@currentEmployee" OnValidSubmit="SaveEmployee">
                    <DataAnnotationsValidator />
                    <ul class="nav nav-tabs" id="employeeTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="true">Thông tin</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="account-tab" data-bs-toggle="tab" data-bs-target="#account" type="button" role="tab" aria-controls="account" aria-selected="false">Tài khoản</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="employeeTabContent">
                        <div class="tab-pane fade show active p-3" id="info" role="tabpanel" aria-labelledby="info-tab">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Họ tên</label>
                                    <InputText class="form-control" @bind-Value="currentEmployee.Name" />
                                    <ValidationMessage For="@(() => currentEmployee.Name)" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ngày sinh</label>
                                    <InputDate class="form-control" @bind-Value="currentEmployee.DateOfBirth" />
                                    <ValidationMessage For="@(() => currentEmployee.DateOfBirth)" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Số điện thoại</label>
                                    <InputText class="form-control" @bind-Value="currentEmployee.Phone" />
                                    <ValidationMessage For="@(() => currentEmployee.Phone)" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Vị trí</label>
                                    <InputText class="form-control" @bind-Value="currentEmployee.Position" />
                                    <ValidationMessage For="@(() => currentEmployee.Position)" />
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade p-3" id="account" role="tabpanel" aria-labelledby="account-tab">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Tên đăng nhập</label>
                                    <InputText class="form-control" @bind-Value="currentEmployee.Account.Username" />
                                    <ValidationMessage For="@(() => currentEmployee.Account.Username)" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Mật khẩu</label>
                                    <InputText type="password" class="form-control" @bind-Value="currentEmployee.Account.Password" />
                                    <ValidationMessage For="@(() => currentEmployee.Account.Password)" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Vai trò</label>
                                    <InputSelect class="form-select" @bind-Value="currentEmployee.Account.Role">
                                        @foreach (var role in Enum.GetValues(typeof(EmployeeRole)))
                                        {
                                            <option value="@role">@role</option>
                                        }
                                    </InputSelect>
                                </div>
                                <div class="col-md-6 mb-3 align-self-center">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input" @bind-Value="currentEmployee.Account.IsActive" id="isActiveCheck" />
                                        <label class="form-check-label" for="isActiveCheck">Kích hoạt</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseModal">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu</button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private List<Employee> employees = new();
    private Employee currentEmployee = new();
    private string modalTitle = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        // --- MOCK DATA LOADING ---
        LoadMockEmployees();

        /*
        // --- TEMPLATE FOR REAL API CALL ---
        try
        {
            var apiResponse = await ApiService.GetEmployeesAsync();
            if(apiResponse.Success)
            {
                employees = apiResponse.Data;
            }
            else
            {
                // Handle error message, e.g., show a toast
                Console.WriteLine(apiResponse.Message);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching employees: {ex.Message}");
        }
        */
    }

    private void LoadMockEmployees()
    {
        employees = new List<Employee>
        {
            new Employee
            {
                Id = "1", Name = "Admin User", DateOfBirth = new DateTime(1990, 1, 1), Phone = "123456789", Position = "Manager",
                Account = new EmployeeAccount { Username = "admin", Password = "admin", Role = EmployeeRole.Admin, IsActive = true }
            },
            new Employee
            {
                Id = "2", Name = "Staff User", DateOfBirth = new DateTime(1995, 5, 5), Phone = "987654321", Position = "Sales",
                Account = new EmployeeAccount { Username = "staff", Password = "staff", Role = EmployeeRole.Staff, IsActive = true }
            }
        };
    }

    private void OpenAddEmployeeModal()
    {
        currentEmployee = new Employee();
        modalTitle = "Thêm nhân viên mới";
        OpenModal();
    }

    private void OpenEditEmployeeModal(Employee employee)
    {
        // In a real app, you might want to clone the object to avoid modifying the list directly before saving.
        currentEmployee = new Employee {
            Id = employee.Id,
            Name = employee.Name,
            DateOfBirth = employee.DateOfBirth,
            Phone = employee.Phone,
            Position = employee.Position,
            Account = new EmployeeAccount
            {
                Username = employee.Account.Username,
                Password = "", // Never pre-fill password
                Role = employee.Account.Role,
                IsActive = employee.Account.IsActive
            }
        };
        modalTitle = $"Sửa thông tin nhân viên: {employee.Name}";
        OpenModal();
    }

    private async Task SaveEmployee()
    {
        // --- MOCK SAVE LOGIC ---
        if (string.IsNullOrEmpty(currentEmployee.Id))
        {
            currentEmployee.Id = Guid.NewGuid().ToString();
            employees.Add(currentEmployee);
        }
        else
        {
            var index = employees.FindIndex(e => e.Id == currentEmployee.Id);
            if (index != -1)
            {
                employees[index] = currentEmployee;
            }
        }

        /*
        // --- TEMPLATE FOR REAL API CALL ---
        try
        {
            if (string.IsNullOrEmpty(currentEmployee.Id))
            {
                await ApiService.CreateEmployeeAsync(currentEmployee);
            }
            else
            {
                await ApiService.UpdateEmployeeAsync(currentEmployee.Id, currentEmployee);
            }
            // Refresh list from server
            // await OnInitializedAsync(); 
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving employee: {ex.Message}");
        }
        */

        CloseModal();
    }

    private async Task DeleteEmployee(Employee employee)
    {
        // --- MOCK DELETE LOGIC ---
        employees.Remove(employee);

        /*
        // --- TEMPLATE FOR REAL API CALL ---
        try
        {
            await ApiService.DeleteEmployeeAsync(employee.Id);
            // Refresh list from server
            // await OnInitializedAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting employee: {ex.Message}");
        }
        */
    }

    private async void OpenModal()
    {
        // Gọi hàm showModal bên index.html
        await JSRuntime.InvokeVoidAsync("showModal", "employeeModal");
    }

    // Sửa lại hàm này
    private async void CloseModal()
    {
        // Gọi hàm hideModal bên index.html
        await JSRuntime.InvokeVoidAsync("hideModal", "employeeModal");
    }
}
