@page "/checkout"
@inject Services.CartService CartService
@inject Services.ApiService ApiService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<h3>Checkout</h3>

@if (cartItems == null || cartItems.Count == 0)
{
    <div class="alert alert-info">Giỏ hàng trống. <a href="/products">Tiếp tục mua sắm</a></div>
}
else
{
    <EditForm Model="orderModel" OnValidSubmit="PlaceOrder">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label>Họ và tên</label>
            <InputText class="form-control" @bind-Value="orderModel.CustomerName" />
        </div>

        <div class="mb-3">
            <label>Địa chỉ</label>
            <InputText class="form-control" @bind-Value="orderModel.Address" />
        </div>

        <div class="mb-3">
            <label>Số điện thoại</label>
            <InputText class="form-control" @bind-Value="orderModel.Phone" />
        </div>

        <div class="mb-3">
            <label>Ghi chú thanh toán (PaymentNote)</label>
            <InputText class="form-control" @bind-Value="orderModel.PaymentNote" />
        </div>

        <h5>Chi tiết đơn hàng</h5>
        <table class="table">
            <thead>
                <tr><th>Sách</th><th>Số lượng</th><th>Đơn giá</th><th>Tổng</th></tr>
            </thead>
            <tbody>
                @foreach (var it in cartItems)
                {
                    <tr>
                        <td>@it.ProductName</td>
                        <td>@it.Quantity</td>
                        <td>@it.Price.ToString("C")</td>
                        <td>@(it.Price * it.Quantity).ToString("C")</td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="mb-3">
            <strong>Tổng cộng: @cartItems.Sum(i => i.Price * i.Quantity).ToString("C")</strong>
        </div>

        <div class="d-flex align-items-center">
            <button class="btn btn-primary" type="submit" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                }
                Xác nhận thanh toán
            </button>
            @if (!string.IsNullOrEmpty(submitError))
            {
                <div class="text-danger ms-3">@submitError</div>
            }
        </div>
    </EditForm>
}

@code {
    private IReadOnlyList<Models.CartItem> cartItems = new List<Models.CartItem>();

    private PlaceOrderModel orderModel = new PlaceOrderModel { PaymentMethod = "CASH", OrderType = "ONLINE" };
    private bool isSubmitting = false;
    private string? submitError;

    protected override void OnInitialized()
    {
        cartItems = CartService.GetCartItems();
    }

    private async Task PlaceOrder()
    {
        submitError = null;
        isSubmitting = true;

        // Check authentication: guests get a client-only confirmation, authenticated users persist to server
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var isAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        // Build request payload (same shape for server persistence)
        var totalAmount = cartItems.Sum(i => i.Price * i.Quantity);

        var request = new Models.CreateInvoiceRequest
        {
            OrderType = orderModel.OrderType,
            PaymentMethod = orderModel.PaymentMethod,
            Phone = orderModel.Phone,
            CustomerName = orderModel.CustomerName,
            Address = orderModel.Address,
            PaymentNote = orderModel.PaymentNote,
            // PaymentStatus and Status are required by backend validation.
            // When customer confirms payment here, set PaymentStatus = "PAID" and Status = "PENDING" (paid but not shipped).
            PaymentStatus = "PAID",
            Status = "PENDING",
            AmountPaid = totalAmount,
            DiscountAmount = 0,
            VoucherId = null,
            Details = cartItems.Select(i => new Models.InvoiceDetailDto
            {
                BookId = i.ProductId,
                Quantity = i.Quantity,
                TotalDiscount = 0
            }).ToList()
        };

            // If authenticated, include CustomerId (saved during registration)
            if (isAuthenticated)
            {
                var storedCustomerId = await LocalStorage.GetItemAsync<string>("customerId");
                if (!string.IsNullOrWhiteSpace(storedCustomerId))
                {
                    request.CustomerId = storedCustomerId;
                }
            }

        try
        {
            if (!isAuthenticated)
            {
                // Guest checkout: client-only confirmation
                await Task.Delay(150); // brief pause for UX
                CartService.Clear();
                Navigation.NavigateTo("/order-confirmation");
                return;
            }

            // Authenticated: call backend to persist invoice
            // Map CreateInvoiceRequest to Invoice for ApiService.CreateOrderAsync
            var invoiceToCreate = new Models.Invoice
            {
                // Populate fields from request as available/relevant
                // Note: Not all fields from CreateInvoiceRequest directly map to Invoice
                // We're mapping enough to satisfy the type requirement for compilation.
                CustomerId = request.CustomerId ?? "Guest", // Default if not authenticated/present
                PaymentMethod = request.PaymentMethod,
                PaymentTime = DateTime.UtcNow, // Or use a relevant time
                TotalAmount = totalAmount, // Assuming totalAmount is the final amount
                Subtotal = totalAmount, // For simplicity, assume same as total for now
                CashierStaffId = "", // Not available in CreateInvoiceRequest
                CustomerPhone = orderModel.Phone,
                // PaymentNote is not in Models.Invoice, removing assignment
                // PaymentNote = request.PaymentNote,
                // InvoiceDetails need to be mapped too
                InvoiceDetails = request.Details.Select(d => new Models.InvoiceDetail
                {
                    BookId = d.BookId,
                    Quantity = d.Quantity,
                    // TotalDiscount is not in Models.InvoiceDetail, removing assignment
                    // TotalDiscount = d.TotalDiscount,
                    // Other fields of InvoiceDetail might need default/dummy values
                    UnitPrice = cartItems.FirstOrDefault(ci => ci.ProductId == d.BookId)?.Price ?? 0,
                    InvoiceId = "" // Will be set by backend
                }).ToList()
            };

            var res = await ApiService.CreateOrderAsync(invoiceToCreate);
            if (res) // ApiService.CreateOrderAsync returns bool
            {
                CartService.Clear();
                // We don't have the new Invoice ID from the dummy CreateOrderAsync,
                // so navigate to a generic confirmation or home page.
                // In a real scenario, the API would return the created Invoice with ID.
                Navigation.NavigateTo("/order-confirmation"); 
            }
            else
            {
                submitError = "Đặt hàng thất bại"; // No message from dummy ApiService.CreateOrderAsync
            }
        }
        catch (Exception ex)
        {
            submitError = ex.Message;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private class PlaceOrderModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string CustomerName { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string Address { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string Phone { get; set; } = string.Empty;

        public string PaymentNote { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string PaymentMethod { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string OrderType { get; set; } = string.Empty;
    }
}
