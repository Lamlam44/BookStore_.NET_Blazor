@page "/checkout"
@inject Services.CartService CartService
@inject StoreManagement.Client.Services.IStoreService StoreService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<h3>Checkout</h3>

@if (cartItems == null || cartItems.Count == 0)
{
    <div class="alert alert-info">Giỏ hàng trống. <a href="/products">Tiếp tục mua sắm</a></div>
}
else
{
    <EditForm Model="orderModel" OnValidSubmit="PlaceOrder">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="card mb-3">
            <div class="card-header bg-light">Thông tin khách hàng</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Họ và tên</label>
                        <InputText class="form-control" @bind-Value="orderModel.CustomerName" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Số điện thoại</label>
                        <InputText class="form-control" @bind-Value="orderModel.Phone" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Địa chỉ</label>
                        <InputText class="form-control" @bind-Value="orderModel.Address" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header bg-light">Thanh toán</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Phương thức</label>
                        <InputSelect class="form-select" @bind-Value="orderModel.PaymentMethod">
                            <option value="CASH">Tiền mặt</option>
                            <option value="TRANSFER">Chuyển khoản</option>
                        </InputSelect>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Ghi chú thanh toán</label>
                        <InputText class="form-control" @bind-Value="orderModel.PaymentNote" />
                    </div>
                </div>
            </div>
        </div>

        <h5>Chi tiết đơn hàng</h5>
        <table class="table table-striped table-bordered">
            <thead>
                <tr><th>Sách</th><th>Số lượng</th><th>Đơn giá</th><th>Tổng</th></tr>
            </thead>
            <tbody>
                @foreach (var it in cartItems)
                {
                    <tr>
                        <td>@it.ProductName</td>
                        <td>@it.Quantity</td>
                        <td>@it.Price.ToString("C")</td>
                        <td>@(it.Price * it.Quantity).ToString("C")</td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="mb-3 text-end">
            <strong>Tổng cộng: @cartItems.Sum(i => i.Price * i.Quantity).ToString("C")</strong>
        </div>

        <div class="d-flex align-items-center">
            <button class="btn btn-primary" type="submit" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                }
                Xác nhận thanh toán
            </button>
            @if (!string.IsNullOrEmpty(submitError))
            {
                <div class="text-danger ms-3">@submitError</div>
            }
        </div>
    </EditForm>
}

@code {
    private IReadOnlyList<Models.CartItem> cartItems = new List<Models.CartItem>();

    private PlaceOrderModel orderModel = new PlaceOrderModel { PaymentMethod = "CASH", OrderType = "ONLINE" };
    private bool isSubmitting = false;
    private string? submitError;

    protected override void OnInitialized()
    {
        cartItems = CartService.GetCartItems();
    }

    private async Task PlaceOrder()
    {
        submitError = null;
        isSubmitting = true;

        // Check authentication: guests get a client-only confirmation, authenticated users persist to server
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var isAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        // Build request payload (same shape for server persistence)
        var totalAmount = cartItems.Sum(i => i.Price * i.Quantity);

        var request = new Models.CreateInvoiceRequest
        {
            OrderType = orderModel.OrderType,
            PaymentMethod = orderModel.PaymentMethod,
            Phone = orderModel.Phone,
            CustomerName = orderModel.CustomerName,
            Address = orderModel.Address,
            PaymentNote = orderModel.PaymentNote,
            // PaymentStatus and Status are required by backend validation.
            // When customer confirms payment here, set PaymentStatus = "PAID" and Status = "PENDING" (paid but not shipped).
            PaymentStatus = "PAID",
            Status = "PENDING",
            AmountPaid = totalAmount,
            DiscountAmount = 0,
            VoucherId = null,
            Details = cartItems.Select(i => new Models.InvoiceDetailDto
            {
                BookId = i.ProductId,
                Quantity = i.Quantity,
                TotalDiscount = 0
            }).ToList()
        };

            // If authenticated, include CustomerId (saved during registration)
            if (isAuthenticated)
            {
                var storedCustomerId = await LocalStorage.GetItemAsync<string>("customerId");
                if (!string.IsNullOrWhiteSpace(storedCustomerId))
                {
                    request.CustomerId = storedCustomerId;
                }
            }

        try
        {
            // Guest flow: create customer record then create ONLINE invoice (no auth required on backend)
            if (!isAuthenticated)
            {
                var createdCustomer = await StoreService.CreateCustomerAndGetAsync(orderModel.CustomerName, orderModel.Phone, orderModel.Address);
                if (createdCustomer == null)
                {
                    submitError = "Tạo khách hàng thất bại.";
                    return;
                }
                request.CustomerId = createdCustomer.Id;

                var ok = await StoreService.CreateOnlineInvoiceAsync(request);
                if (!ok)
                {
                    submitError = "Tạo hóa đơn thất bại.";
                    return;
                }

                CartService.Clear();
                Navigation.NavigateTo("/");
                return;
            }

            // Authenticated: also create ONLINE invoice (or POS per business rule). Using ONLINE here for consistency.
            var okAuth = await StoreService.CreateOnlineInvoiceAsync(request);
            if (okAuth)
            {
                CartService.Clear();
                Navigation.NavigateTo("/");
            }
            else
            {
                submitError = "Tạo hóa đơn thất bại.";
            }
        }
        catch (Exception ex)
        {
            submitError = ex.Message;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private class PlaceOrderModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string CustomerName { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string Address { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string Phone { get; set; } = string.Empty;

        public string PaymentNote { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string PaymentMethod { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string OrderType { get; set; } = string.Empty;
    }
}
