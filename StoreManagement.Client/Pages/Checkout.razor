@page "/checkout"
@inject Services.CartService CartService
@inject StoreManagement.Client.Services.IStoreService StoreService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject IJSRuntime JSRuntime

<h3>Checkout</h3>

@if (cartItems == null || cartItems.Count == 0)
{
    <div class="alert alert-info">Giỏ hàng trống. <a href="/products">Tiếp tục mua sắm</a></div>
}
else
{
    <EditForm Model="orderModel" OnValidSubmit="PlaceOrder">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="card mb-3">
            <div class="card-header bg-light">Thông tin khách hàng</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Họ và tên</label>
                        <InputText class="form-control" @bind-Value="orderModel.CustomerName" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Số điện thoại</label>
                        <InputText class="form-control" @bind-Value="orderModel.Phone" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email</label>
                        <InputText class="form-control" @bind-Value="orderModel.Email" />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Địa chỉ</label>
                        <InputText class="form-control" @bind-Value="orderModel.Address" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header bg-light">Thanh toán</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Phương thức</label>
                        <InputSelect class="form-select" @bind-Value="orderModel.PaymentMethod">
                            <option value="CASH">Tiền mặt</option>
                            <option value="TRANSFER">Chuyển khoản</option>
                        </InputSelect>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Ghi chú thanh toán</label>
                        <InputText class="form-control" @bind-Value="orderModel.PaymentNote" />
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-3">
            <div class="card-header bg-light">Áp dụng khuyến mãi</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-8 position-relative">
                        <label class="form-label">Nhập mã giảm giá</label>
                        <input class="form-control" placeholder="VD: SUMMER-2025" @bind="voucherInput" @oninput="OnVoucherInput" />
                        @if (voucherSuggestions.Any())
                        {
                            <ul class="list-group position-absolute w-100" style="z-index:3000; max-height:220px; overflow:auto;">
                                @foreach (var v in voucherSuggestions)
                                {
                                    <li class="list-group-item list-group-item-action d-flex justify-content-between" @onclick="() => SelectVoucher(v)">
                                        <span><strong>@v.VoucherCode</strong> — @v.VoucherName</span>
                                        <small class="text-muted">@(v.VoucherType == "Percentage" ? $"-{v.DiscountValue}%" : $"-{v.DiscountValue:N0} đ")</small>
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button type="button" class="btn btn-warning w-100" @onclick="ApplyVoucher" disabled="@isSubmitting">Áp dụng</button>
                    </div>
                </div>
                @if (appliedVoucher != null)
                {
                    <div class="alert alert-success mt-3 mb-0">
                        Đã áp dụng: <strong>@appliedVoucher.VoucherCode</strong> — @appliedVoucher.VoucherName. Số tiền giảm: <strong>@appliedDiscountDisplay</strong>
                    </div>
                }
            </div>
        </div>

        <h5>Chi tiết đơn hàng</h5>
        <table class="table table-striped table-bordered">
            <thead>
                <tr><th>Sách</th><th>Số lượng</th><th>Đơn giá</th><th>Tổng</th></tr>
            </thead>
            <tbody>
                @foreach (var it in cartItems)
                {
                    <tr>
                        <td>@it.ProductName</td>
                        <td>@it.Quantity</td>
                        <td>@it.Price.ToString("C")</td>
                        <td>@(it.Price * it.Quantity).ToString("C")</td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="mb-3 text-end">
            <div>Tạm tính: <strong>@Subtotal.ToString("C")</strong></div>
            <div>Giảm giá: <strong class="text-danger">-@AppliedDiscount.ToString("C")</strong></div>
            <div>Tổng thanh toán: <strong class="fs-5">@TotalAfterDiscount.ToString("C")</strong></div>
        </div>

        <div class="d-flex align-items-center">
            <button class="btn btn-primary" type="submit" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                }
                Xác nhận thanh toán
            </button>
            @if (!string.IsNullOrEmpty(submitError))
            {
                <div class="text-danger ms-3">@submitError</div>
            }
        </div>
    </EditForm>
}

@code {
    private IReadOnlyList<Models.CartItem> cartItems = new List<Models.CartItem>();

    private PlaceOrderModel orderModel = new PlaceOrderModel { PaymentMethod = "CASH", OrderType = "ONLINE" };
    private bool isSubmitting = false;
    private bool submissionGuard = false;
    private string? submitError;

    // Voucher state
    private string voucherInput = string.Empty;
    private List<Models.Voucher> voucherSuggestions = new();
    private Models.Voucher? appliedVoucher;
    private decimal appliedDiscount = 0m;
    private string appliedDiscountDisplay => AppliedDiscount.ToString("C");

    private decimal Subtotal => cartItems.Sum(i => i.Price * i.Quantity);
    private decimal AppliedDiscount => Math.Clamp(appliedDiscount, 0, Subtotal);
    private decimal TotalAfterDiscount => Subtotal - AppliedDiscount;

    // Cache from admin vouchers page to know targets
    private Dictionary<string, VoucherDisplayInfo>? voucherDisplayCache;
    private class VoucherDisplayInfo
    {
        public string VoucherType { get; set; } = "Percentage";
        public decimal DiscountValue { get; set; }
        public string TargetType { get; set; } = "PRODUCT_TARGET";
        public List<string> TargetNames { get; set; } = new();
        public List<string> TargetIds { get; set; } = new();
    }
    private List<Book> allBooks = new();

    protected override void OnInitialized()
    {
        cartItems = CartService.GetCartItems();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Preload cache and book catalog for category checks
            try
            {
                var json = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "voucherDisplayCache");
                if (!string.IsNullOrWhiteSpace(json))
                {
                    voucherDisplayCache = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, VoucherDisplayInfo>>(json);
                }
            }
            catch { }
            try
            {
                allBooks = await StoreService.GetBooksAsync();
            }
            catch { }
            StateHasChanged();
        }
    }

    private async Task OnVoucherInput(ChangeEventArgs e)
    {
        voucherInput = e.Value?.ToString() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(voucherInput) || voucherInput.Trim().Length < 2)
        {
            voucherSuggestions.Clear();
            return;
        }

        var all = await StoreService.GetVouchersAsync();
        voucherSuggestions = all
            .Where(v => !string.IsNullOrWhiteSpace(v.VoucherCode) && v.VoucherCode.Contains(voucherInput.Trim(), StringComparison.OrdinalIgnoreCase))
            .Take(15)
            .ToList();
    }

    private void SelectVoucher(Models.Voucher v)
    {
        voucherInput = v.VoucherCode;
        appliedVoucher = v;
        voucherSuggestions.Clear();
    }

    private Task ApplyVoucher()
    {
        if (appliedVoucher == null)
        {
            appliedDiscount = 0m;
            return Task.CompletedTask;
        }

        // Compute eligible items based on admin-defined targets (from localStorage)
        var eligibleQuantity = 0;
        var eligibleSubtotal = 0m;
        if (voucherDisplayCache != null && !string.IsNullOrWhiteSpace(appliedVoucher.VoucherCode)
            && voucherDisplayCache.TryGetValue(appliedVoucher.VoucherCode, out var info)
            && info.TargetIds.Any())
        {
            if (string.Equals(info.TargetType, "PRODUCT_TARGET", StringComparison.OrdinalIgnoreCase))
            {
                var eligibleIds = new HashSet<string>(info.TargetIds);
                foreach (var ci in cartItems)
                {
                    if (!string.IsNullOrWhiteSpace(ci.ProductId) && eligibleIds.Contains(ci.ProductId))
                    {
                        eligibleQuantity += ci.Quantity;
                        eligibleSubtotal += ci.Price * ci.Quantity;
                    }
                }
            }
            else // CATEGORY_TARGET
            {
                var eligibleCatIds = new HashSet<string>(info.TargetIds);
                // Map productId -> categoryId from catalog
                var categoryByProduct = allBooks.Where(b => !string.IsNullOrWhiteSpace(b.Id))
                    .ToDictionary(b => b.Id!, b => b.CategoryId ?? string.Empty);
                foreach (var ci in cartItems)
                {
                    if (!string.IsNullOrWhiteSpace(ci.ProductId)
                        && categoryByProduct.TryGetValue(ci.ProductId, out var catId)
                        && !string.IsNullOrWhiteSpace(catId)
                        && eligibleCatIds.Contains(catId))
                    {
                        eligibleQuantity += ci.Quantity;
                        eligibleSubtotal += ci.Price * ci.Quantity;
                    }
                }
            }
        }
        else
        {
            // No target info: treat nothing as eligible (safer than applying to all)
            eligibleQuantity = 0;
            eligibleSubtotal = 0m;
        }

        if (appliedVoucher.VoucherType == "Percentage")
        {
            appliedDiscount = Math.Round(eligibleSubtotal * (appliedVoucher.DiscountValue / 100m), 0, MidpointRounding.AwayFromZero);
        }
        else
        {
            // Fixed (VNĐ) discounts apply per eligible item in cart
            var totalFixed = appliedVoucher.DiscountValue * eligibleQuantity;
            appliedDiscount = Math.Min(totalFixed, eligibleSubtotal);
        }
        return Task.CompletedTask;
    }

    private async Task PlaceOrder()
    {
        if (submissionGuard) return; // prevent double submissions
        submissionGuard = true;
        submitError = null;
        isSubmitting = true;

        var confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Bạn có chắc chắn xác nhận thanh toán?");
        if (!confirm)
        {
            isSubmitting = false;
            submissionGuard = false;
            return;
        }

        // Check authentication: guests get a client-only confirmation, authenticated users persist to server
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var isAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        // Build request payload (same shape for server persistence)
        var totalAmount = TotalAfterDiscount;

        var request = new Models.CreateInvoiceRequest
        {
            OrderType = orderModel.OrderType,
            PaymentMethod = orderModel.PaymentMethod,
            Phone = orderModel.Phone,
            CustomerName = orderModel.CustomerName,
            Address = orderModel.Address,
            PaymentNote = orderModel.PaymentNote,
            // PaymentStatus and Status are required by backend validation.
            // When customer confirms payment here, set PaymentStatus = "PAID" and Status = "PENDING" (paid but not shipped).
            PaymentStatus = "PAID",
            Status = "PENDING",
            AmountPaid = totalAmount,
            DiscountAmount = AppliedDiscount,
            VoucherId = appliedVoucher?.Id,
            Details = cartItems.Select(i => new Models.InvoiceDetailDto
            {
                BookId = i.ProductId,
                Quantity = i.Quantity,
                TotalDiscount = 0
            }).ToList()
        };

            // If authenticated, include CustomerId (saved during registration)
            if (isAuthenticated)
            {
                var storedCustomerId = await LocalStorage.GetItemAsync<string>("customerId");
                if (!string.IsNullOrWhiteSpace(storedCustomerId))
                {
                    request.CustomerId = storedCustomerId;
                }
            }

        try
        {
            // Guest flow: create customer record then create ONLINE invoice (no auth required on backend)
            if (!isAuthenticated)
            {
                var createdCustomer = await StoreService.CreateCustomerAndGetAsync(orderModel.CustomerName, orderModel.Phone, orderModel.Address);
                if (createdCustomer == null)
                {
                    submitError = "Tạo khách hàng thất bại.";
                    return;
                }
                request.CustomerId = createdCustomer.Id;

                var ok = await StoreService.CreateOnlineInvoiceAsync(request);
                if (!ok)
                {
                    submitError = "Tạo hóa đơn thất bại.";
                    return;
                }

                CartService.Clear();
                await JSRuntime.InvokeVoidAsync("alert", "Thanh toán thành công!");
                Navigation.NavigateTo("/");
                return;
            }

            // Authenticated: also create ONLINE invoice (or POS per business rule). Using ONLINE here for consistency.
            var okAuth = await StoreService.CreateOnlineInvoiceAsync(request);
            if (okAuth)
            {
                CartService.Clear();
                await JSRuntime.InvokeVoidAsync("alert", "Thanh toán thành công!");
                Navigation.NavigateTo("/");
            }
            else
            {
                submitError = "Tạo hóa đơn thất bại.";
            }
        }
        catch (Exception ex)
        {
            submitError = ex.Message;
        }
        finally
        {
            isSubmitting = false;
            submissionGuard = false;
        }
    }

    private class PlaceOrderModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string CustomerName { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string Address { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string Phone { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.EmailAddress]
        public string Email { get; set; } = string.Empty;

        public string PaymentNote { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string PaymentMethod { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required]
        public string OrderType { get; set; } = string.Empty;
    }
}
