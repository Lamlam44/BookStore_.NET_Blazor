@page "/orders/{Id}"
@layout StoreManagement.Client.Layout.CustomerLayout
@inject Services.ApiService ApiService
@inject NavigationManager Navigation

<h3>Chi tiết đơn hàng</h3>

@if (isLoading)
{
    <p><em>Loading...</em></p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else if (invoice != null)
{
    <div class="card">
        <div class="card-body">
            <h5>Mã đơn: @invoice.Id</h5>
            <p>Khách hàng: @invoice.CustomerPhone</p>
            <p>Thời gian: @invoice.PaymentTime.ToString("g")</p>
            <p>Phương thức thanh toán: @invoice.PaymentMethod</p>

            <h6>Chi tiết</h6>
            <table class="table">
                <thead><tr><th>Sách</th><th>Số lượng</th><th>Đơn giá</th><th>Tổng</th></tr></thead>
                <tbody>
                    @foreach (var d in invoice.InvoiceDetails)
                    {
                        <tr>
                            <td>@d.Book?.Title</td>
                            <td>@d.Quantity</td>
                            <td>@d.UnitPrice.ToString("C")</td>
                            <td>@(d.UnitPrice * d.Quantity).ToString("C")</td>
                        </tr>
                    }
                </tbody>
            </table>
            <div class="text-end"><strong>Tổng: @invoice.TotalAmount.ToString("C")</strong></div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string Id { get; set; }

    private bool isLoading = true;
    private string? errorMessage;
    private StoreManagement.Client.Models.Invoice? invoice;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var res = await ApiService.GetOrderByIdAsync(Id);
            if (res?.Success == true && res.Data != null)
            {
                invoice = res.Data;
            }
            else
            {
                errorMessage = res?.Message ?? "Không tìm thấy đơn hàng";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }
}
