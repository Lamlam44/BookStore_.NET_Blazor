@page "/timekeeping"
@using System.Timers
@using StoreManagement.Client.Models
@using StoreManagement.Client.Services
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject ApiService ApiService
@implements IDisposable

<div class="container text-center mt-5">
    <div class="mb-4">
        <h3>@currentDate.ToString("dddd, dd/MM/yyyy")</h3>
    </div>

    <div class="card shadow-lg mx-auto" style="max-width: 400px;">
        <div class="card-body p-5">
            <h1 class="display-4 font-weight-bold mb-4">@currentTime.ToString("HH:mm:ss")</h1>

            @if (!isShiftStarted)
            {
                <button class="btn btn-success btn-lg w-100" @onclick="StartShift">
                    <i class="oi oi-media-play me-2"></i> BẮT ĐẦU CA
                </button>
            }
            else
            {
                <div class="mb-3">
                    <p class="mb-1"><strong>Bắt đầu lúc:</strong> @shiftStartTime.ToString("HH:mm:ss")</p>
                    <p class="mb-0"><strong>Thời gian làm việc:</strong> @shiftDuration.ToString(@"hh\:mm\:ss")</p>
                </div>
                <button class="btn btn-danger btn-lg w-100" @onclick="EndShift">
                    <i class="oi oi-media-stop me-2"></i> KẾT THÚC CA
                </button>
            }
        </div>
    </div>

    <div class="mt-5">
        <h4 class="mb-3">Lịch sử chấm công gần đây</h4>
        <table class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Ngày</th>
                    <th>Bắt đầu</th>
                    <th>Kết thúc</th>
                    <th>Trạng thái</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var entry in shiftHistory)
                {
                    <tr>
                        <td>@entry.Date.ToString("dd/MM/yyyy")</td>
                        <td>@entry.StartTime.ToString("HH:mm")</td>
                        <td>@(entry.EndTime?.ToString("HH:mm") ?? "N/A")</td>
                        <td><span class="badge @(entry.Status == "Đã hoàn thành" ? "bg-success" : "bg-warning")">@entry.Status</span></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private System.Timers.Timer? timer;
    private DateTime currentDate = DateTime.Now;
    private DateTime currentTime = DateTime.Now;
    private bool isShiftStarted = false;
    private DateTime shiftStartTime;
    private TimeSpan shiftDuration;

    private List<ShiftHistoryEntry> shiftHistory = new();

    protected override async Task OnInitializedAsync()
    {
        var userRole = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "UserRole");
        if (userRole != "Staff")
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        timer = new System.Timers.Timer(1000);
        timer.Elapsed += OnTimerElapsed;
        timer.Start();
        
        // --- MOCK DATA LOADING ---
        LoadMockShiftHistory();

        /*
        // --- TEMPLATE FOR REAL API CALL ---
        try
        {
            var response = await ApiService.GetShiftHistoryAsync();
            if(response.Success)
            {
                shiftHistory = response.Data;
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error fetching shift history: {ex.Message}");
        }
        */
    }

    private void OnTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        currentTime = DateTime.Now;
        if (isShiftStarted)
        {
            shiftDuration = DateTime.Now - shiftStartTime;
        }
        InvokeAsync(StateHasChanged);
    }

    private async Task StartShift()
    {
        // --- MOCK LOGIC ---
        isShiftStarted = true;
        shiftStartTime = DateTime.Now;
        shiftHistory.Insert(0, new ShiftHistoryEntry
        {
            Date = currentDate.Date,
            StartTime = shiftStartTime,
            Status = "Đang làm việc"
        });

        /*
        // --- TEMPLATE FOR REAL API CALL ---
        try
        {
            var response = await ApiService.StartShiftAsync();
            if(response.Success)
            {
                isShiftStarted = true;
                shiftStartTime = DateTime.Now;
                // Optionally refresh history
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error starting shift: {ex.Message}");
        }
        */
    }

    private async Task EndShift()
    {
        // --- MOCK LOGIC ---
        isShiftStarted = false;
        var currentShift = shiftHistory.FirstOrDefault(s => s.Status == "Đang làm việc");
        if (currentShift != null)
        {
            currentShift.EndTime = DateTime.Now;
            currentShift.Status = "Đã hoàn thành";
        }
        
        /*
        // --- TEMPLATE FOR REAL API CALL ---
        try
        {
            var response = await ApiService.EndShiftAsync();
            if(response.Success)
            {
                isShiftStarted = false;
                // Optionally refresh history
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error ending shift: {ex.Message}");
        }
        */
    }

    private void LoadMockShiftHistory()
    {
        shiftHistory = new List<ShiftHistoryEntry>
        {
            new ShiftHistoryEntry { Date = DateTime.Now.AddDays(-1).Date, StartTime = new DateTime(2025, 10, 19, 8, 2, 0), EndTime = new DateTime(2025, 10, 19, 17, 5, 0), Status = "Đã hoàn thành" },
            new ShiftHistoryEntry { Date = DateTime.Now.AddDays(-2).Date, StartTime = new DateTime(2025, 10, 18, 7, 59, 0), EndTime = new DateTime(2025, 10, 18, 17, 3, 0), Status = "Đã hoàn thành" },
        };
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}
