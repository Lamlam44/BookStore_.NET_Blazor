@page "/timekeeping"
@layout StoreManagement.Client.Layout.AdminLayout
@attribute [Authorize(Roles="STAFF, ADMIN")]
@using System.Timers
@using StoreManagement.Client.Models
@using StoreManagement.Client.Services
@inject NavigationManager NavigationManager
@inject ApiService ApiService
@implements IDisposable

<div class="container text-center mt-5">
    <div class="mb-4">
        <h3>@currentDate.ToString("dddd, dd/MM/yyyy")</h3>
    </div>

    <div class="card shadow-lg mx-auto" style="max-width: 400px;">
        <div class="card-body p-5">
            <h1 class="display-4 font-weight-bold mb-4">@currentTime.ToString("HH:mm:ss")</h1>

            @if (!isShiftStarted)
            {
                <button class="btn btn-success btn-lg w-100" @onclick="StartShift">
                    <i class="oi oi-media-play me-2"></i> BẮT ĐẦU CA
                </button>
            }
            else
            {
                <div class="mb-3">
                    <p class="mb-1"><strong>Bắt đầu lúc:</strong> @shiftStartTime.ToString("HH:mm:ss")</p>
                    <p class="mb-0"><strong>Thời gian làm việc:</strong> @shiftDuration.ToString(@"hh\:mm\:ss")</p>
                </div>
                <button class="btn btn-danger btn-lg w-100" @onclick="EndShift">
                    <i class="oi oi-media-stop me-2"></i> KẾT THÚC CA
                </button>
            }
        </div>
    </div>

    <div class="mt-5">
        <h4 class="mb-3">Lịch sử chấm công gần đây</h4>
        <table class="table table-striped table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Ngày</th>
                    <th>Bắt đầu</th>
                    <th>Kết thúc</th>
                    <th>Trạng thái</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var entry in shiftHistory)
                {
                    <tr>
                        <td>@entry.Date.ToString("dd/MM/yyyy")</td>
                        <td>@entry.StartTime.ToString("HH:mm")</td>
                        <td>@(entry.EndTime?.ToString("HH:mm") ?? "N/A")</td>
                        <td><span class="badge @(entry.Status == "Đã hoàn thành" ? "bg-success" : "bg-warning")">@entry.Status</span></td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private System.Timers.Timer? timer;
    private DateTime currentDate = DateTime.Now;
    private DateTime currentTime = DateTime.Now;
    private bool isShiftStarted = false;
    private DateTime shiftStartTime;
    private TimeSpan shiftDuration;

    private List<ShiftHistoryEntry> shiftHistory = new();

    protected override async Task OnInitializedAsync()
    {
        timer = new System.Timers.Timer(1000);
        timer.Elapsed += OnTimerElapsed;
        timer.Start();
        
        await LoadShiftHistory();
    }

    private void OnTimerElapsed(object? sender, ElapsedEventArgs e)
    {
        currentTime = DateTime.Now;
        if (isShiftStarted)
        {
            shiftDuration = DateTime.Now - shiftStartTime;
        }
        InvokeAsync(StateHasChanged);
    }

    private async Task StartShift()
    {
        try
        {
            var response = await ApiService.StartShiftAsync();
            if(response.Success)
            {
                isShiftStarted = true;
                shiftStartTime = DateTime.Now;
                await LoadShiftHistory(); // Refresh history
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error starting shift: {ex.Message}");
        }
    }

    private async Task EndShift()
    {
        try
        {
            var response = await ApiService.EndShiftAsync();
            if(response.Success)
            {
                isShiftStarted = false;
                await LoadShiftHistory(); // Refresh history
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error ending shift: {ex.Message}");
        }
    }

    private async Task LoadShiftHistory()
    {
        try
        {
            var response = await ApiService.GetShiftHistoryAsync();
            if(response.Success)
            {
                shiftHistory = response.Data ?? new();
                isShiftStarted = shiftHistory.Any(s => s.Status == "Đang làm việc");
                if (isShiftStarted) {
                    shiftStartTime = shiftHistory.First(s => s.Status == "Đang làm việc").StartTime;
                }
            }
        }
        catch(Exception ex)
        {
            Console.WriteLine($"Error fetching shift history: {ex.Message}");
        }
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}
