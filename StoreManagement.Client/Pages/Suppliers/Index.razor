@page "/suppliers"
@using StoreManagement.Client.Models
@using StoreManagement.Client.Services
@inject IStoreService StoreService
@inject IJSRuntime JSRuntime

<style>
    /* N·ªÅn trang */
    body { background-color: #f8f9fc; font-family: 'Segoe UI', sans-serif; }

    /* Header */
    h3 { font-weight: 700; color: #0d6efd; }

    /* TABLE STYLE */
    .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        overflow: hidden; /* ƒê·ªÉ bo g√≥c table */
    }
    .table thead th {
        background-color: #0d6efd; /* Xanh d∆∞∆°ng ƒë·∫≠m */
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        padding: 15px;
        border: none;
    }
    .table tbody td {
        padding: 15px;
        vertical-align: middle;
        color: #5a5c69;
        border-bottom: 1px solid #e3e6f0;
    }
    .table-hover tbody tr:hover {
        background-color: #f1f7ff; /* Highlight xanh nh·∫°t khi hover */
    }

    /* Input Group */
    .input-group input { border-radius: 8px 0 0 8px; }
    .input-group button { border-radius: 0 8px 8px 0; }

    /* MODAL STYLE (GI·ªÆ NGUY√äN) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.55); display: flex; justify-content: center; align-items: center; z-index: 2000; animation: fadeIn 0.3s ease-out; }
    .custom-modal { background: white; width: 700px; max-width: 90%; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); display: flex; flex-direction: column; animation: popupShow 0.3s ease-out; }
    .modal-header { padding: 15px 20px; background: #0d6efd; color: white; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 20px; overflow-y: auto; max-height: 70vh; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #ddd; text-align: right; background: #f8f9fa; border-radius: 0 0 12px 12px; }

    @@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @@keyframes popupShow { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>üè¢ Qu·∫£n L√Ω Nh√† Cung C·∫•p</h3>

    <div class="d-flex gap-2">
        <div class="input-group" style="width: 300px;">
            <input type="text" class="form-control" placeholder="T√¨m ki·∫øm t√™n, SƒêT..."
                   @bind="searchTerm" @bind:event="oninput" @onkeyup="HandleEnterKey" />
            <button class="btn btn-primary" @onclick="SearchData">
                <i class="bi bi-search"></i>
            </button>
        </div>

        <button class="btn btn-success fw-bold shadow-sm" @onclick="ShowCreateForm">
            <i class="bi bi-plus-lg me-1"></i> Th√™m M·ªõi
        </button>
    </div>
</div>

@* --- DANH S√ÅCH NH√Ä CUNG C·∫§P (D·∫†NG TABLE) --- *@
@if (suppliers == null)
{
    <div class="text-center mt-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
    </div>
}
else if (suppliers.Count == 0)
{
    <div class="alert alert-warning text-center mt-4 border-0 shadow-sm">
        <i class="bi bi-inbox fs-4 d-block mb-2"></i>
        Hi·ªán ch∆∞a c√≥ nh√† cung c·∫•p n√†o. Nh·∫•n "Th√™m M·ªõi" ƒë·ªÉ t·∫°o ngay.
    </div>
}
else
{
    <div class="table-container table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th style="width: 25%;">T√™n Nh√† Cung C·∫•p</th>
                    <th style="width: 20%;">Ng∆∞·ªùi Li√™n H·ªá</th>
                    <th style="width: 15%;">S·ªë ƒêi·ªán Tho·∫°i</th>
                    <th style="width: 25%;">ƒê·ªãa Ch·ªâ</th>
                    <th style="width: 15%;" class="text-end">H√†nh ƒê·ªông</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in suppliers)
                {
                    <tr>
                        <td>
                            <div class="fw-bold text-primary">@item.SupplierName</div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="bi bi-person-circle text-muted me-2"></i>
                                @item.ContactPerson
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">
                                <i class="bi bi-telephone-fill text-success me-1" style="font-size: 0.7rem;"></i>
                                @item.Phone
                            </span>
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 200px;" title="@item.Address">
                                <i class="bi bi-geo-alt-fill text-danger me-1"></i>
                                @item.Address
                            </div>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-warning btn-action me-2 shadow-sm"
                                    @onclick="() => ShowEditForm(item)"
                                    title="S·ª≠a th√¥ng tin">
                                <i class="bi bi-pencil-square me-1"></i> S·ª≠a
                            </button>
                            
                            @* N√∫t xem l·ªãch s·ª≠ *@
                            <a href="/suppliers/@item.Id"
                                class="btn btn-info btn-action shadow-sm"
                                title="Xem l·ªãch s·ª≠ nh·∫≠p h√†ng">
                                    <i class="bi bi-clock-history me-1"></i> L·ªãch s·ª≠
                            </a>    
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@* --- POPUP FORM (MODAL - GI·ªÆ NGUY√äN) --- *@
@if (showForm)
{
    <div class="modal-overlay" @onclick="CloseFormOutside">
        <div class="custom-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h5 class="mb-0 fw-bold">
                    @(string.IsNullOrEmpty(currentSupplier.Id) ? "‚ú® Th√™m Nh√† Cung C·∫•p M·ªõi" : "‚úèÔ∏è C·∫≠p Nh·∫≠t Th√¥ng Tin")
                </h5>
                <button type="button" class="btn-close btn-close-white" @onclick="CancelForm"></button>
            </div>
            <div class="modal-body">
                <EditForm id="supplierForm" Model="currentSupplier" OnValidSubmit="HandleSubmit">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger mb-3" />

                    <div class="mb-3">
                        <label class="form-label fw-bold">T√™n Nh√† Cung C·∫•p (*)</label>
                        <InputText class="form-control" @bind-Value="currentSupplier.SupplierName" placeholder="VD: C√¥ng ty S√°ch Ph∆∞∆°ng Nam" />
                        <ValidationMessage For="@(() => currentSupplier.SupplierName)" />
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Ng∆∞·ªùi li√™n h·ªá</label>
                            <InputText class="form-control" @bind-Value="currentSupplier.ContactPerson" placeholder="VD: Anh Nam" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i</label>
                            <InputText class="form-control" @bind-Value="currentSupplier.Phone" placeholder="090..." />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">ƒê·ªãa ch·ªâ</label>
                        <InputTextArea class="form-control" @bind-Value="currentSupplier.Address" rows="3" />
                    </div>
                </EditForm>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary me-2" @onclick="CancelForm">H·ªßy b·ªè</button>
                <button type="submit" form="supplierForm" class="btn btn-primary fw-bold px-4">
                    <i class="bi bi-check2-circle me-1"></i> L∆∞u L·∫°i
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<Supplier>? suppliers;
    private bool showForm = false;
    private Supplier currentSupplier = new Supplier();
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            suppliers = await StoreService.GetSuppliersAsync();
        else
            suppliers = await StoreService.SearchSuppliersAsync(searchTerm);
    }

    private async Task SearchData() => await LoadData();

    private async Task HandleEnterKey(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await SearchData();
        if (string.IsNullOrWhiteSpace(searchTerm)) await LoadData();
    }

    private void ShowCreateForm()
    {
        currentSupplier = new Supplier();
        currentSupplier.Id = string.Empty; // Reset ID ƒë·ªÉ bi·∫øt l√† Create
        showForm = true;
    }

    private void ShowEditForm(Supplier s)
    {
        currentSupplier = new Supplier
        {
            Id = s.Id,
            SupplierName = s.SupplierName,
            ContactPerson = s.ContactPerson,
            Phone = s.Phone,
            Address = s.Address,
            InventoryReceipts = s.InventoryReceipts
        };
        showForm = true;
    }

    private void CancelForm() => showForm = false;
    private void CloseFormOutside() => showForm = false;

    private async Task HandleSubmit()
    {
        if (string.IsNullOrEmpty(currentSupplier.Id))
            await StoreService.CreateSupplierAsync(currentSupplier);
        else
            await StoreService.UpdateSupplierAsync(currentSupplier);

        showForm = false;
        await LoadData();
    }
}