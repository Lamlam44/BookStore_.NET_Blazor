@page "/"
@layout StoreManagement.Client.Layout.CustomerLayout
@using StoreManagement.Client.Models
@inject StoreManagement.Client.Services.ApiService ApiService
@inject StoreManagement.Client.Services.CartService CartService

<PageTitle>Trang chủ bán sách</PageTitle>

<div class="container py-4">
    <h2 class="mb-4 fw-bold text-primary"><i class="bi bi-book-half me-2"></i>Danh sách sách hiện có</h2>

    @if (books == null)
    {
        <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-3 g-4">
            @foreach (var item in books)
            {
                <div class="col">
                    <div class="card h-100 shadow-sm border-0 hover-shadow">
                        @* SỬA 1: Dùng item.Image thay vì item.ImageUrl *@
                           <div class="position-relative" style="height: 280px; overflow: hidden; background: #f8f9fa;">
                           <img src="@(string.IsNullOrEmpty(item.Image) ? "/images/no-image.svg" : item.Image)" 
                               class="card-img-top h-100 w-100" 
                               style="object-fit: contain; padding: 10px;" 
                               alt="@item.Title"
                               onerror="this.src='/images/no-image.svg'" />
                        </div>
                        
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold text-dark text-truncate" title="@item.Title">@item.Title</h5>
                            
                            <p class="card-text text-muted small mb-2">
                                <i class="bi bi-person-fill"></i> @(string.IsNullOrEmpty(item.Author) ? "Đang cập nhật" : item.Author)
                            </p>

                            @* SỬA 2: Dùng item.RetailPrice thay vì item.Price *@
                            <h5 class="card-text text-danger fw-bold mt-auto">
                                @item.RetailPrice.ToString("N0") đ
                            </h5>
                        </div>
                        
                        <div class="card-footer bg-white border-top-0 pb-3">
                            <button class="btn btn-primary w-100 rounded-pill fw-bold">
                                <i class="bi bi-cart-plus me-1"></i> Thêm vào giỏ
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<style>
    .hover-shadow:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        transition: all 0.3s ease;
    }
</style>

@code {
    private List<Book>? books;

    protected override async Task OnInitializedAsync()
    {
        await LoadBooksFromApi();
    }

    private async Task LoadBooksFromApi()
    {
        try
        {
            var res = await ApiService.GetProductsAsync();
            if (res != null && res.Success)
            {
                books = res.Data;
            }
            else
            {
                books = new List<Book>();
            }
        }
        catch
        {
            books = new List<Book>();
        }
    }

    private void AddToCart(Book b)
    {
        CartService.AddToCart(b);
    }
}