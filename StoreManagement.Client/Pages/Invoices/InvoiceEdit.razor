@page "/admin/invoices/edit/{Id}"
@layout AdminLayout
@inject StoreManagement.Client.Services.ApiService ApiService
@inject NavigationManager Navigation

<h3 class="mb-4">Sửa Hóa đơn</h3>

@if (isLoading)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
    <button @onclick='() => Navigation.NavigateTo($"/admin/invoices/detail/{Id}")' class="btn btn-secondary mt-3">Quay lại Chi tiết Hóa đơn</button>
}
else if (invoiceRequest == null)
{
    <div class="alert alert-info">Không tìm thấy hóa đơn để sửa.</div>
    <button @onclick='() => Navigation.NavigateTo("/admin/invoices")' class="btn btn-secondary mt-3">Quay lại Danh sách Hóa đơn</button>
}
else
{
    <EditForm Model="invoiceRequest" OnValidSubmit="HandleValidSubmit" FormName="editInvoiceForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Thông tin Hóa đơn</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="orderType" class="form-label">Loại đơn hàng:</label>
                        <InputSelect @bind-Value="invoiceRequest.OrderType" class="form-select" id="orderType">
                            <option value="ONLINE">Trực tuyến</option>
                            <option value="POS">POS</option>
                        </InputSelect>
                        <ValidationMessage For="@(() => invoiceRequest.OrderType)" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="paymentMethod" class="form-label">Phương thức thanh toán:</label>
                                            <InputSelect @bind-Value="invoiceRequest.PaymentMethod" class="form-select" id="paymentMethod">
                                                <option value="">Chọn phương thức thanh toán</option>
                                                <option value="CASH">Tiền mặt</option>
                                                <option value="TRANSFER">Chuyển khoản</option>
                                            </InputSelect>                        <ValidationMessage For="@(() => invoiceRequest.PaymentMethod)" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="customerId" class="form-label">ID Khách hàng (Optional):</label>
                        <InputText @bind-Value="invoiceRequest.CustomerId" class="form-control" id="customerId" placeholder="Nhập ID Khách hàng" />
                        <ValidationMessage For="@(() => invoiceRequest.CustomerId)" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="discountAmount" class="form-label">Số tiền giảm giá:</label>
                        <InputNumber @bind-Value="invoiceRequest.DiscountAmount" class="form-control" id="discountAmount" />
                        <ValidationMessage For="@(() => invoiceRequest.DiscountAmount)" />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="voucherId" class="form-label">ID Voucher (Optional):</label>
                        <InputText @bind-Value="invoiceRequest.VoucherId" class="form-control" id="voucherId" placeholder="Nhập ID Voucher" />
                        <ValidationMessage For="@(() => invoiceRequest.VoucherId)" />
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="amountPaid" class="form-label">Số tiền đã thanh toán:</label>
                        <InputNumber @bind-Value="invoiceRequest.AmountPaid" class="form-control" id="amountPaid" />
                        <ValidationMessage For="@(() => invoiceRequest.AmountPaid)" />
                    </div>
                </div>
                <div class="mb-3">
                    <label for="paymentNote" class="form-label">Ghi chú thanh toán (Optional):</label>
                    <InputTextArea @bind-Value="invoiceRequest.PaymentNote" class="form-control" id="paymentNote" rows="2" />
                    <ValidationMessage For="@(() => invoiceRequest.PaymentNote)" />
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Chi tiết Sản phẩm</h5>
            </div>
            <div class="card-body">
                @if (invoiceRequest.Details.Any())
                {
                    <table class="table table-bordered table-striped">
                        <thead class="table-light">
                            <tr>
                                <th>ID Sách</th>
                                <th>Số lượng</th>
                                <th>ID Voucher (Optional)</th>
                                <th>Giảm giá</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < invoiceRequest.Details.Count; i++)
                            {
                                var item = invoiceRequest.Details[i];
                                <tr>
                                    <td><InputText @bind-Value="item.BookId" class="form-control" /></td>
                                    <td><InputNumber @bind-Value="item.Quantity" class="form-control" /></td>
                                    <td><InputText @bind-Value="item.VoucherId" class="form-control" /></td>
                                    <td><InputNumber @bind-Value="item.TotalDiscount" class="form-control" /></td>
                                    <td>
                                        <button type="button" class="btn btn-danger btn-sm" @onclick="(() => RemoveDetail(item))">Xóa</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="alert alert-info">Chưa có sản phẩm nào.</div>
                }
                <button type="button" class="btn btn-info mt-2" @onclick="AddDetail">Thêm sản phẩm</button>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(submissionErrorMessage))
        {
            <div class="alert alert-danger mt-3">@submissionErrorMessage</div>
        }

        <div class="d-flex justify-content-between mt-3">
            <button type="submit" class="btn btn-success" disabled="@isSubmitting">
                @if (isSubmitting)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                }
                Cập nhật Hóa đơn
            </button>
            <button type="button" class="btn btn-secondary" @onclick='() => Navigation.NavigateTo($"/admin/invoices/detail/{Id}")'>Hủy</button>
        </div>
    </EditForm>
}

@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;

    private AdminUpdateInvoiceRequest? invoiceRequest;
    private bool isLoading = true;
    private string errorMessage = string.Empty;
    private bool isSubmitting = false;
    private string submissionErrorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoiceForEdit();
    }

    private async Task LoadInvoiceForEdit()
    {
        isLoading = true;
        errorMessage = string.Empty;
        try
        {
            var result = await ApiService.GetAdminInvoiceByIdAsync(Id);
            if (result.Success && result.Data != null)
            {
                // Map AdminInvoiceDetailResponse to AdminUpdateInvoiceRequest
                invoiceRequest = new AdminUpdateInvoiceRequest
                {
                    OrderType = result.Data.OrderType,
                    PaymentMethod = result.Data.PaymentMethod,
                    CustomerId = result.Data.Customer?.Id,
                    DiscountAmount = result.Data.TotalDiscount, // Assuming TotalDiscount maps to DiscountAmount here
                    VoucherId = null, // Backend does not return VoucherId at invoice level
                    AmountPaid = result.Data.AmountPaid,
                    PaymentNote = result.Data.PaymentNote,
                    Details = result.Data.Details.Select(d => new AdminInvoiceDetailItem
                    {
                        BookId = d.BookId,
                        Quantity = d.Quantity,
                        VoucherId = null, // Backend does not return VoucherId at detail level
                        TotalDiscount = d.TotalDiscount
                    }).ToList()
                };
            }
            else
            {
                errorMessage = result.Message ?? "Không thể tải chi tiết hóa đơn để sửa.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải hóa đơn: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void AddDetail()
    {
        if (invoiceRequest != null)
        {
            invoiceRequest.Details.Add(new AdminInvoiceDetailItem { Quantity = 1, TotalDiscount = 0 });
        }
    }

    private void RemoveDetail(AdminInvoiceDetailItem item)
    {
        if (invoiceRequest != null)
        {
            invoiceRequest.Details.Remove(item);
        }
    }

    private async Task HandleValidSubmit()
    {
        if (invoiceRequest == null) return;

        isSubmitting = true;
        submissionErrorMessage = string.Empty;

        try
        {
            var result = await ApiService.UpdateAdminInvoiceAsync(Id, invoiceRequest);
            if (result.Success)
            {
                Navigation.NavigateTo($"/admin/invoices/detail/{result.Data?.Id}");
            }
            else
            {
                submissionErrorMessage = result.Message ?? "Cập nhật hóa đơn thất bại.";
            }
        }
        catch (Exception ex)
        {
            submissionErrorMessage = $"Lỗi: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }
}
