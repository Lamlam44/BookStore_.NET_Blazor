@page "/cart"
@layout StoreManagement.Client.Layout.CustomerLayout
@inject CartService CartService
@implements IDisposable

<h3>Shopping Cart</h3>

@if (!cartItems.Any())
{
    <p>Your cart is empty.</p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Product</th>
                <th>Price</th>
                <th>Quantity</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in cartItems)
            {
                <tr>
                    <td>
                        <img src="@item.Image" alt="@item.ProductName" style="width: 50px; height: 50px; object-fit: cover;" />
                        @item.ProductName
                    </td>
                    <td>@item.Price.ToString("C")</td>
                    <td>@item.Quantity</td>
                    <td>
                        <button class="btn btn-danger btn-sm" @onclick="() => RemoveFromCart(item.ProductId)">Remove</button>
                    </td>
                </tr>
            }
        </tbody>
        <tfoot>
            <tr>
                <td colspan="2"></td>
                <td><strong>Total:</strong></td>
                <td><strong>@total.ToString("C")</strong></td>
            </tr>
        </tfoot>
    </table>
    <div class="text-end">
        <button class="btn btn-primary">Proceed to Checkout</button>
    </div>
}

@code {
    private IReadOnlyList<CartItem> cartItems = new List<CartItem>();
    private decimal total = 0;

    protected override void OnInitialized()
    {
        CartService.OnChange += OnCartChanged;
        LoadCart();
    }

    private void LoadCart()
    {
        cartItems = CartService.GetCartItems();
        total = CartService.GetTotal();
    }

    private void OnCartChanged()
    {
        LoadCart();
        StateHasChanged();
    }

    private void RemoveFromCart(string productId)
    {
        CartService.RemoveFromCart(productId);
    }

    public void Dispose()
    {
        CartService.OnChange -= OnCartChanged;
    }
}
